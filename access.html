<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sign in · Rolling FTE Planner</title>
<style>
  :root{
    --bg:#f6f8fc;--panel:#fff;--border:#e5e7eb;--muted:#64748b;--ink:#0f172a;--brand:#18b6a0;--brand2:#12927f;--err:#dc2626
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:880px;margin:40px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .brand{font-weight:800;letter-spacing:.2px}
  .badge{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  h3{margin:0 0 10px 0}
  .input{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  .input label{font-size:12px;color:var(--muted)}
  input,button{height:42px;border:1px solid var(--border);border-radius:10px;padding:8px;font:inherit}
  input[type="email"],input[type="password"]{background:#fff}
  button{cursor:pointer;background:#fff}
  .btn{border-color:#d1d5db}
  .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;border:none}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .err{color:var(--err);min-height:18px}
  .ok{color:#16a34a}
  .foot{margin-top:12px;display:flex;justify-content:space-between;align-items:center}
  .hidden{display:none}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  /* Visually neutralize Chrome autofill tint (optional) */
  input:-webkit-autofill{
    transition: background-color 9999s ease-in-out 0s;
    -webkit-text-fill-color: var(--ink) !important;
  }
</style>
<meta http-equiv="Cache-Control" content="no-store" />
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Rolling FTE Planner</div>
    <span id="build" class="badge">access build 2025-10-10a</span>
  </header>

  <div class="grid">
    <!-- Sign in -->
    <form class="card" id="loginForm" autocomplete="off">
      <h3>Sign in</h3>
      <div class="input">
        <label>Email</label>
        <input
          id="loginEmail"
          name="lf_email"
          type="email"
          placeholder="you@company.com"
          autocomplete="off"
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          inputmode="email"
          readonly
        />
      </div>
      <div class="input">
        <label>Password</label>
        <input
          id="loginPass"
          name="lf_pass"
          type="password"
          placeholder="********"
          autocomplete="off"
          readonly
        />
      </div>
      <div class="row">
        <button id="btnLogin" class="btn primary" type="button">Sign in</button>
      </div>
      <div id="loginErr" class="err"></div>
      <!-- Honeypot to further discourage autofill robots -->
      <input type="text" style="display:none" tabindex="-1" aria-hidden="true" autocomplete="off">
      <input type="password" style="display:none" tabindex="-1" aria-hidden="true" autocomplete="new-password">
    </form>

    <!-- Create account -->
    <form class="card" id="createForm" autocomplete="off">
      <h3>Create account</h3>
      <div class="input">
        <label>Email</label>
        <input
          id="createEmail"
          name="cf_email"
          type="email"
          placeholder="you@company.com"
          autocomplete="off"
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          inputmode="email"
          readonly
        />
      </div>
      <div class="input">
        <label>Password (min 8)</label>
        <input
          id="createPass"
          name="cf_pass"
          type="password"
          placeholder="********"
          minlength="8"
          autocomplete="new-password"
          readonly
        />
      </div>
      <div class="row">
        <button id="btnCreate" class="btn" type="button">Create account</button>
      </div>
      <div id="createErr" class="err"></div>
      <!-- Honeypot -->
      <input type="text" style="display:none" tabindex="-1" aria-hidden="true" autocomplete="off">
      <input type="password" style="display:none" tabindex="-1" aria-hidden="true" autocomplete="new-password">
    </form>
  </div>

  <div class="foot">
    <span id="status" class="muted"></span>
    <button id="btnToApp" class="btn hidden" type="button">Go to app</button>
  </div>
</div>

<!-- Firebase v10 CDN (modules) -->
<script type="module">
  /************* EDIT ONLY IF YOU CHANGE OWNER EMAIL *************/
  const OWNER_EMAIL = "phoneemail07@gmail.com";   // <- you are the only Superadmin

  // --- Your Firebase config (from your console) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBG9uJSuftXsRqvIxo2NZPRJmsLGro3vbA",
    authDomain: "fte-planner.firebaseapp.com",
    projectId: "fte-planner",
    storageBucket: "fte-planner.firebasestorage.app",
    messagingSenderId: "410936425819",
    appId: "1:410936425819:web:4332c19848bf6ef64c2e7e",
    measurementId: "G-0BZP3LETBE"
  };

  // --- Load Firebase modules from CDN ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Helpers
  const $ = s => document.querySelector(s);
  const STATUS = $('#status');

  function setSession(email, role){
    const exp = Date.now() + 1000*60*60*12; // 12h
    localStorage.setItem('fte-session', JSON.stringify({ email, role, exp }));
  }
  function toIndex(){ location.href = 'index.html'; }

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence);

  // Optional reset hook
  (function(){
    const u = new URL(location.href);
    if (u.searchParams.get('reset') === '1') {
      try { localStorage.removeItem('fte-session'); } catch {}
    }
  })();

  // --- Anti-autofill: unlock inputs on first user focus and always start blank ---
  const fields = ['loginEmail','loginPass','createEmail','createPass'].map(id => $('#'+id));

  function clearAllFields(){
    fields.forEach(f => { if (f) f.value = ''; });
  }
  function unlockOnFocus(el){
    if (!el) return;
    el.addEventListener('focus', () => {
      if (el.hasAttribute('readonly')) {
        el.removeAttribute('readonly');
      }
    }, { once:true });
  }
  fields.forEach(unlockOnFocus);

  // Clear on load, on visibility changes, and before bfcache restore
  window.addEventListener('pageshow', (e) => {
    // if restored from bfcache, ensure blank
    clearAllFields();
  });
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') clearAllFields();
  });
  // Initial clear after DOM paints
  setTimeout(clearAllFields, 0);

  // UI handlers
  $('#btnLogin').onclick = async () => {
    $('#loginErr').textContent = '';
    STATUS.textContent = 'Signing in…';
    try{
      const email = ($('#loginEmail').value||'').trim().toLowerCase();
      const pass  = $('#loginPass').value||'';
      if(!email || !pass){ $('#loginErr').textContent='Enter email and password.'; STATUS.textContent=''; return; }
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      const role = (email === OWNER_EMAIL.toLowerCase()) ? 'superadmin' : 'user';
      setSession(cred.user.email, role);
      clearAllFields();
      toIndex();
    }catch(e){
      $('#loginErr').textContent = mapAuthError(e);
      STATUS.textContent = '';
      clearAllFields();
    }
  };

  $('#btnCreate').onclick = async () => {
    $('#createErr').textContent = '';
    STATUS.textContent = 'Creating account…';
    try{
      const email = ($('#createEmail').value||'').trim().toLowerCase();
      const pass  = $('#createPass').value||'';
      if(!email || !pass){ $('#createErr').textContent='Enter email and password.'; STATUS.textContent=''; return; }
      if(pass.length < 8){ $('#createErr').textContent='Password must be at least 8 characters.'; STATUS.textContent=''; return; }
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const role = (email === OWNER_EMAIL.toLowerCase()) ? 'superadmin' : 'user';
      setSession(cred.user.email, role);
      clearAllFields();
      toIndex();
    }catch(e){
      $('#createErr').textContent = mapAuthError(e);
      STATUS.textContent = '';
      clearAllFields();
    }
  };

  // Auto-send to app if still valid
  onAuthStateChanged(auth, (user) => {
    if(!user) return;
    const role = (user.email?.toLowerCase() === OWNER_EMAIL.toLowerCase()) ? 'superadmin' : 'user';
    setSession(user.email||'', role);
    $('#btnToApp').classList.remove('hidden');
    $('#btnToApp').onclick = toIndex;
    // Also clear fields in case user navigates back here
    clearAllFields();
  });

  function mapAuthError(e){
    const c = e?.code || '';
    if(c.includes('auth/invalid-credential')) return 'Invalid email or password.';
    if(c.includes('auth/invalid-email')) return 'Invalid email address.';
    if(c.includes('auth/user-not-found')) return 'Account not found.';
    if(c.includes('auth/wrong-password')) return 'Incorrect password.';
    if(c.includes('auth/email-already-in-use')) return 'Email is already registered.';
    if(c.includes('auth/network-request-failed')) return 'Network error. Try again.';
    return 'Error: ' + (e?.message || 'Unknown error');
  }

  // Status line
  try{
    STATUS.textContent = 'Firebase Auth: ready';
  }catch{ STATUS.textContent = 'Firebase not initialized'; }
</script>

<!-- Inline error panel (for quick debugging) -->
<div id="errbox" style="position:fixed;left:8px;bottom:8px;right:8px;max-height:40vh;overflow:auto;background:#111;color:#fff;padding:8px;border-radius:8px;font:12px/1.4 monospace;display:none;z-index:99999"></div>
<script>
(function(){
  function show(msg){
    var b=document.getElementById('errbox');
    if (!b) return;
    b.style.display='block';
    var p=document.createElement('div');
    p.textContent = '['+new Date().toISOString()+'] ' + msg;
    b.appendChild(p);
  }
  window.addEventListener('load', function(){ show('JS loaded ✓'); }, {once:true});
  window.onerror = function(msg, src, lin, col, err){
    show('Error: '+msg+' @ '+(src||'')+':'+lin+':'+col+(err&&err.stack?'\n'+err.stack:'')); return false;
  };
  window.addEventListener('unhandledrejection', function(e){
    var r=e.reason; show('Promise error: '+(r && (r.stack||r.message||r)));
  });
})();
</script>

</body>
</html>
