<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rolling FTE Planner · Access</title>
<style>
  :root{--bg:#f6f8fc;--panel:#fff;--border:#e5e7eb;--muted:#64748b;--brand:#18b6a0;--err:#dc2626}
  html,body{margin:0;background:var(--bg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#fff}
  .chip{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px}
  .wrap{max-width:980px;margin:22px auto;padding:0 12px}
  h1{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .input{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .input label{font-size:12px;color:var(--muted)}
  input,select,button{height:40px;border:1px solid var(--border);border-radius:10px;padding:8px}
  button{cursor:pointer;background:#fff}
  .btn.primary{background:linear-gradient(180deg,#18b6a0,#12927f);color:#fff;border:none}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .err{color:var(--err)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <div class="row">
    <strong>Rolling FTE Planner · Access</strong>
    <span class="chip" id="buildChip">access build 2025-10-07b</span>
  </div>
  <span id="cfgBadge" class="chip">Loading config…</span>
</header>

<div class="wrap">
  <p class="muted">Sign in with your email. Only the owner can create the single Superadmin.</p>

  <div class="grid">
    <!-- Sign in -->
    <div class="card">
      <h3>Sign in</h3>
      <div class="input"><label>Email</label><input id="loginEmail" type="email" placeholder="you@company.com" autocomplete="username"></div>
      <div class="input"><label>Password</label><input id="loginPass" type="password" placeholder="********" autocomplete="current-password"></div>
      <div class="row">
        <button id="btnLogin" class="btn primary">Sign in</button>
        <button id="btnReset" class="btn">Reset password</button>
      </div>
      <div id="loginErr" class="err" style="margin-top:8px"></div>
    </div>

    <!-- Create account -->
    <div class="card">
      <h3>Create account</h3>
      <div class="input"><label>Email</label><input id="createEmail" type="email" placeholder="you@company.com" autocomplete="username"></div>
      <div class="input"><label>Password (min 8)</label><input id="createPass" type="password" minlength="8" placeholder="********" autocomplete="new-password"></div>

      <div class="input">
        <label>Role</label>
        <select id="createRole">
          <option value="user" selected>Regular user</option>
          <option value="superadmin">Superadmin (owner only)</option>
        </select>
      </div>

      <div id="ownerGate" style="display:none">
        <div class="input"><label>Owner email (from config.json)</label><input id="ownerEmail" type="email" readonly></div>
        <div class="input"><label>Owner access code</label><input id="ownerCode" type="password" placeholder="code" autocomplete="off"></div>
      </div>

      <div class="row">
        <button id="btnCreate" class="btn primary">Create account</button>
      </div>
      <div id="createErr" class="err" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- Firebase + logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // ---- Your Firebase project (replace only if you created a different project)
  const firebaseConfig = {
    apiKey: "AIzaSyBG9uJSuftXsRqvIxo2NZPRJmsLGro3vbA",
    authDomain: "fte-planner.firebaseapp.com",
    projectId: "fte-planner",
    storageBucket: "fte-planner.firebasestorage.app",
    messagingSenderId: "410936425819",
    appId: "1:410936425819:web:4332c19848bf6ef64c2e7e",
    measurementId: "G-0BZP3LETBE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // ---- Config (owner email + code) pulled from config.json
  let OWNER_EMAIL = "";
  let OWNER_ACCESS_CODE = "";
  async function loadConfig(){
    const badge=document.getElementById('cfgBadge');
    try{
      const res = await fetch('config.json?ts=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const cfg = await res.json();
      OWNER_EMAIL = String(cfg.ownerEmail || cfg.owner_email || '').trim().toLowerCase();
      OWNER_ACCESS_CODE = String(cfg.ownerAccessCode || cfg.owner_access_code || '');
      document.getElementById('ownerEmail').value = OWNER_EMAIL;
      badge.textContent = 'Config loaded for owner';
    }catch(e){
      badge.textContent = 'Config missing';
    }
  }
  loadConfig();

  // ---- If already signed in, go to app
  onAuthStateChanged(auth, (user) => {
    if (user) location.href = 'index.html';
  });

  // ---- UI helpers
  const roleSel = document.getElementById('createRole');
  function toggleOwnerGate(){
    document.getElementById('ownerGate').style.display =
      roleSel.value==='superadmin' ? 'block' : 'none';
  }
  roleSel.onchange = toggleOwnerGate; toggleOwnerGate();

  // ---- Create account
  document.getElementById('btnCreate').onclick = async () => {
    const createErr = document.getElementById('createErr'); createErr.textContent='';
    const email = (document.getElementById('createEmail').value||'').trim().toLowerCase();
    const pass  = document.getElementById('createPass').value||'';
    const role  = roleSel.value;

    if(!email){ createErr.textContent='Enter your email.'; return; }
    if(pass.length<8){ createErr.textContent='Password must be at least 8 characters.'; return; }

    try{
      if(role==='superadmin'){
        if(!OWNER_EMAIL){ createErr.textContent='Owner config not loaded.'; return; }
        const ownerCode = document.getElementById('ownerCode').value||'';
        if(email !== OWNER_EMAIL){ createErr.textContent='Superadmin email must equal the owner email.'; return; }
        if(ownerCode !== OWNER_ACCESS_CODE){ createErr.textContent='Owner access code invalid.'; return; }
      }

      await createUserWithEmailAndPassword(auth, email, pass);
      // Firebase will sign the user in and the onAuthStateChanged above redirects to index.html
    }catch(err){
      createErr.textContent = (err?.message||'Create failed');
    }
  };

  // ---- Login
  document.getElementById('btnLogin').onclick = async () => {
    const loginErr = document.getElementById('loginErr'); loginErr.textContent='';
    const email = (document.getElementById('loginEmail').value||'').trim();
    const pass  = document.getElementById('loginPass').value||'';
    if(!email || !pass){ loginErr.textContent='Enter your email and password.'; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      // Redirect happens from onAuthStateChanged
    }catch(err){
      loginErr.textContent = (err?.message||'Sign-in failed');
    }
  };

  // ---- Reset password
  document.getElementById('btnReset').onclick = async () => {
    const loginErr = document.getElementById('loginErr'); loginErr.textContent='';
    const email = (document.getElementById('loginEmail').value||'').trim();
    if(!email){ loginErr.textContent='Enter your email first, then click reset.'; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      loginErr.textContent='Reset email sent (check inbox).';
      loginErr.classList.remove('err');
    }catch(err){
      loginErr.textContent = (err?.message||'Reset failed');
      loginErr.classList.add('err');
    }
  };
</script>
</body>
</html>
