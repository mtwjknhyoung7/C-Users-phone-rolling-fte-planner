<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rolling FTE Planner</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#f5f7fb;--panel:#fff;--muted:#64748b;--text:#0f172a;--border:#e5e7eb;--brand:#18b6a0;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626;--chip:#eef2ff}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(900px 300px at -10% -10%, rgba(24,182,160,.08), transparent 60%),#f3f6fb;color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header.appbar{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 22px rgba(2,6,23,.06)}
  .brand{font-weight:800;letter-spacing:.2px}.chip{background:var(--chip);border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.muted{color:var(--muted)}.ok{color:var(--ok)}.danger{color:var(--err)}
  .wrap{display:grid;grid-template-columns:310px 1fr;gap:14px;min-height:100vh;padding:14px}
  aside.sidebar{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 22px rgba(2,6,23,.06);padding:12px;height:calc(100vh - 110px);position:sticky;top:86px;overflow:auto}
  .sec{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#fff}
  .sec h3{margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.5px;color:#334155}
  .input{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}.input label{font-size:12px;color:#64748b}
  .input input,.input select{height:38px;border:1px solid var(--border);border-radius:10px;padding:8px;width:100%}
  .hint{font-size:11px;color:#94a3b8}
  main.content{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 22px rgba(2,6,23,.06);padding:12px;min-height:calc(100vh - 110px)}
  .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#18b6a0,#12927f);border-color:#108574;color:#fff}
  .month-row{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#fff}
  .month-head{display:flex;justify-content:space-between;align-items:center;gap:10px}.m-title{font-weight:700}
  .kpis{display:grid;grid-template-columns:repeat(14,minmax(110px,1fr));gap:12px;margin-top:8px}
  .k{display:flex;flex-direction:column;gap:4px;min-width:110px}.k label{font-size:11px;color:#6b7280}
  .k input{height:38px;border:1px solid var(--border);border-radius:10px;padding:6px 8px;width:100%}
  .k input[maxlength]{font-variant-numeric:tabular-nums}
  .k .val{font-weight:700;min-height:38px;display:flex;align-items:center;padding:6px 8px;border:1px dashed #e5e7eb;border-radius:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .month-body{margin-top:10px;display:none}.month-row.open .month-body{display:block}
  .diag-item{border-left:4px solid var(--err);padding:8px;background:#fff;border:1px solid var(--border);border-left-color:var(--err);border-radius:8px;margin-bottom:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left} thead th{background:#f8fafc;font-weight:700} tbody tr:last-child td{border-bottom:none}
  .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}.seg button{border:none;background:#fff;padding:6px 10px;cursor:pointer}.seg button.active{background:linear-gradient(180deg,#18b6a0,#12927f);color:#fff}
  .card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#fff}
  .gridwrap{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .gridwrap table{margin:0;border:none;border-radius:0}
  .gridwrap thead th{position:sticky;top:0;z-index:1}
  @media (max-width:1180px){.wrap{grid-template-columns:1fr}aside.sidebar{position:static;height:auto}}
</style>
</head>
<body>

<!-- Auth guard -->
<script>
(function () {
  const KEY='fte-session';
  const u=new URL(location.href);
  if(u.searchParams.get('reset')==='1'){ try{localStorage.removeItem('fte-state-v2');localStorage.removeItem(KEY);}catch{} }
  const safe=(u.hash==='#safe'||u.searchParams.get('safe')==='1');
  if(safe){try{window.__FTE_SESSION__=JSON.parse(localStorage.getItem(KEY)||'null');}catch{} return;}
  let s=null;try{s=JSON.parse(localStorage.getItem(KEY)||'null');}catch{location.href='access.html';return}
  if(!s||!s.email||!s.role){location.href='access.html';return}
  if(s.exp && Date.now()>=Number(s.exp)){localStorage.removeItem(KEY);location.href='access.html';return}
  window.__FTE_SESSION__=s;
})();
</script>

<header class="appbar">
  <div class="row">
    <div class="brand">Rolling FTE Planner</div>
    <span class="chip" id="horizonChip"></span>
    <span class="chip">build 2025-10-07a</span>
  </div>
  <div class="row"><span class="muted" id="userInfo"></span><button class="btn small" id="btnSignOut">Sign out</button></div>
</header>

<div class="wrap">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sec" id="secGlobal">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Global Settings</h3>
        <button id="btnToggleGlobal" class="btn small">Collapse</button>
      </div>
      <div id="globalBody">
        <div class="input"><label>Comp / hour</label><input id="g_comp" type="text" inputmode="decimal" placeholder="1.75"></div>
        <div class="row">
          <div class="input" style="flex:1"><label>Hours / day</label><input id="g_hours" type="text" inputmode="decimal" placeholder="8"></div>
          <div class="input" style="flex:1"><label>Shrinkage %</label><input id="g_shrink" type="text" inputmode="decimal" placeholder="35"></div>
        </div>
        <div class="row">
          <div class="input" style="flex:1"><label>Service Level %</label><input id="g_sl" type="text" inputmode="decimal" placeholder="95"></div>
          <div class="input" style="flex:1"><label>Patient Attrition % (default)</label><input id="g_attr" type="text" inputmode="decimal" placeholder="3.5"></div>
        </div>
        <div class="row">
          <div class="input" style="flex:1"><label>FTE Attrition % (default)</label><input id="g_fteattr" type="text" inputmode="decimal" placeholder="3.5"></div>
        </div>
        <div class="hint">FTE Need = (SL×NetPatients) ÷ (Workdays×Hours/day×Comp/hr×(1−Shrinkage)).</div>
      </div>
    </div>

    <div class="sec">
      <h3>Tenure Ramp (Productivity)</h3>
      <div class="row">
        <div class="input" style="flex:1"><label>0–30 days %</label><input id="r_0" type="text" inputmode="decimal" placeholder="5"></div>
        <div class="input" style="flex:1"><label>31–60 days %</label><input id="r_1" type="text" inputmode="decimal" placeholder="50"></div>
        <div class="input" style="flex:1"><label>90+ days %</label><input id="r_2" type="text" inputmode="decimal" placeholder="100"></div>
      </div>
      <div class="hint">Ramp applies on Outbound – Staff as “Effective Supply.”</div>
    </div>

    <div class="sec">
      <h3>Holidays</h3>
      <div class="row">
        <div class="input" style="flex:1"><label>Month</label><input id="h_month" type="month"></div>
        <div class="input" style="flex:1"><label>Date</label><input id="h_date" type="date"></div>
      </div>
      <div class="row"><button class="btn small" id="btnAddHoliday">Add</button><button class="btn small" id="btnClearHoliday">Clear month</button></div>
      <div class="hint" id="h_list">No holidays in selected month.</div>
    </div>

    <div class="sec" id="ioSec">
      <h3>Data I/O (Superadmin)</h3>
      <div class="row"><input id="csvFile" type="file" accept=".csv"/><button class="btn small" id="btnImportCsv">Import Outbound CSV</button></div>
      <div class="row"><button class="btn small" id="btnExportJson">Export JSON</button></div>
      <div class="hint">CSV headers: month(YYYY-MM), som_patients, enrollments, attrition_pct, practice_loss, som_fte, new_hires</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="content">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="overview">Outbound</button>
      <button class="tab" data-tab="staff">Outbound – Staff</button>
      <button class="tab" data-tab="inbound">Inbound</button>
      <button class="tab" data-tab="instaff">Inbound – Staff</button>
      <button class="tab" data-tab="exec">Executive Summary</button>
      <button class="tab" data-tab="diag">Diagnostics</button>
      <span class="seg" style="margin-left:auto"><button id="btnCollapseAll">Collapse all months</button><button id="btnExpandAll">Expand all</button></span>
    </div>

    <!-- Outbound -->
    <section id="tab-overview">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:200px"><label>Start month</label><input id="startMonth" type="month"></div>
        <div class="input" style="width:140px"><label>Months</label><select id="horizon"><option>6</option><option selected>12</option><option>18</option><option>24</option></select></div>
        <button class="btn small" id="btnRebuild">Apply</button>
      </div>
      <div id="months"></div>
    </section>

    <!-- Outbound – Staff -->
    <section id="tab-staff" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:220px"><label>View starting month</label><input id="staffStart" type="month"></div>
        <button class="btn small" id="btnStaffGo">Go</button>
        <div class="row" style="margin-left:auto">
          <div class="input" style="width:120px"><label>% 8h</label><input id="mix8" type="text" inputmode="decimal" placeholder="60"></div>
          <div class="input" style="width:120px"><label>% 10h</label><input id="mix10" type="text" inputmode="decimal" placeholder="20"></div>
          <div class="input" style="width:120px"><label>% 6h PT</label><input id="mix6" type="text" inputmode="decimal" placeholder="10"></div>
          <div class="input" style="width:120px"><label>% 4h PT</label><input id="mix4" type="text" inputmode="decimal" placeholder="10"></div>
        </div>
      </div>
      <table id="staffTbl">
        <thead>
          <tr>
            <th>Month</th><th>FTE Need</th>
            <th>Staffed (SOM FTE)</th><th>Effective Supply (ramp)</th>
            <th>Gap vs Effective</th><th>8h</th><th>10h</th><th>6h PT</th><th>4h PT</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">
        Effective Supply = SOM FTE − (prev1 new hires × (1−r1)) − (prev2 new hires × (1−r1)) + (this-month new hires × r0).
      </div>
    </section>

    <!-- Inbound -->
    <section id="tab-inbound" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:8px">
        <div class="row" style="gap:14px">
          <div class="input" style="width:150px"><label>Work month (holidays)</label><input id="in_month" type="month"></div>
          <div class="input" style="width:130px"><label>AHT (sec)</label><input id="in_aht" type="text" inputmode="numeric" placeholder="480" value=""></div>
          <div class="input" style="width:140px"><label>Target SL %</label><input id="in_sl" type="text" inputmode="decimal" placeholder="80" value=""></div>
          <div class="input" style="width:150px"><label>SL threshold T (sec)</label><input id="in_t" type="text" inputmode="numeric" placeholder="30" value=""></div>
          <div class="input" style="width:150px"><label>Interval (min)</label>
            <select id="in_ivl"><option>15</option><option selected>30</option><option>60</option></select>
          </div>
          <div class="input" style="width:150px"><label>Shrinkage % (override)</label><input id="in_shrink" type="text" inputmode="decimal" placeholder="(global)"></div>
        </div>

        <div class="row">
          <button class="btn small" id="btnBuildIntervals">Build empty day</button>
          <label class="btn small" style="display:inline-flex;gap:8px;align-items:center">
            <input id="in_csv" type="file" accept=".csv" style="display:none"><span>Upload CSV</span>
          </label>
          <button class="btn small" id="btnImportInbound">Import</button>
          <button class="btn small" id="btnInboundCalc">Compute staffing</button>
          <button class="btn small" id="btnExportInbound">Export</button>
        </div>
      </div>

      <div class="hint" style="margin-bottom:6px">
        CSV columns accepted: <b>datetime,calls</b> (optional <b>aht_sec,target_asa_sec</b>). We bin by interval-of-day.
        Service level: <code>SL = 1 - ErlangC × exp(-(N - a) × T / AHT)</code>, with <code>a = calls*AHT / interval_seconds</code>.
      </div>

      <div class="gridwrap" id="intervalGrid" style="display:none">
        <table>
          <thead><tr><th>Interval</th><th>Calls</th><th>Load (erl)</th><th>Agents N</th><th>SL %</th><th>ASA (s)</th><th>Agents w/ Shrink</th></tr></thead>
          <tbody id="intervalBody"></tbody>
        </table>
      </div>

      <div class="cards" style="margin-top:10px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>Daily Coverage</strong><span class="pill" id="in_summary_hdr">—</span>
          </div>
          <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:8px">
            <span class="pill">Daily agent-hours: <b id="in_agent_hours">0.0</b></span>
            <span class="pill">Avg concurrent agents: <b id="in_avg_agents">0.0</b></span>
            <span class="pill">Peak agents: <b id="in_peak_agents">0</b></span>
            <span class="pill">Daily FTE (effective): <b id="in_daily_fte">0.0</b></span>
            <span class="pill">Monthly FTE: <b id="in_monthly_fte">0.0</b></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Inbound – Staff -->
    <section id="tab-instaff" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:220px"><label>View starting month</label><input id="inStaffStart" type="month"></div>
        <button class="btn small" id="btnInStaffGo">Go</button>
        <div class="row" style="margin-left:auto">
          <div class="input" style="width:120px"><label>% 8h</label><input id="imix8" type="text" inputmode="decimal" placeholder="60"></div>
          <div class="input" style="width:120px"><label>% 10h</label><input id="imix10" type="text" inputmode="decimal" placeholder="20"></div>
          <div class="input" style="width:120px"><label>% 6h PT</label><input id="imix6" type="text" inputmode="decimal" placeholder="10"></div>
          <div class="input" style="width:120px"><label>% 4h PT</label><input id="imix4" type="text" inputmode="decimal" placeholder="10"></div>
        </div>
      </div>
      <table id="inStaffTbl">
        <thead><tr><th>Month</th><th>Inbound FTE Need</th><th>Inbound Staffed (editable)</th><th>Gap</th><th>8h</th><th>10h</th><th>6h PT</th><th>4h PT</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">Inbound need comes from the Inbound tab’s monthly computation. Enter staffed inbound FTE per month here.</div>
    </section>

    <!-- Executive Summary -->
    <section id="tab-exec" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row"><span class="chip" id="execRange"></span></div>
        <div class="row">
          <div class="seg execwin">
            <button class="active" data-execwin="1">Current</button>
            <button data-execwin="3">3 Mo</button>
            <button data-execwin="6">6 Mo</button>
            <button data-execwin="12">12 Mo</button>
          </div>
          <select id="exportMode" class="btn small" style="border-radius:8px">
            <option value="outbound" selected>Export: Outbound</option>
            <option value="inbound">Export: Inbound</option>
            <option value="both">Export: Both</option>
          </select>
          <button class="btn small" id="btnExportSummary">Export</button>
        </div>
      </div>
      <div class="cards" id="execCards" style="margin-top:10px"></div>
      <div class="cards" style="margin-top:10px">
        <div class="card"><canvas id="chartNet"></canvas></div>
        <div class="card"><canvas id="chartFte"></canvas></div>
      </div>
    </section>

    <!-- Diagnostics -->
    <section id="tab-diag" style="display:none"><div id="diagList"></div></section>
  </main>
</div>

<script>
/* ===== Utilities & session ===== */
const session=window.__FTE_SESSION__||{email:'(safe)',role:'user'};
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const readNum=el=>{const s=(el?.value||'').replace(/[^0-9.\-]/g,'');const v=parseFloat(s);return isNaN(v)?0:v;}
const setNum=(el,v,dec=0)=>{el.value=(isFinite(v)?Number(v).toFixed(dec):'');}
document.getElementById('userInfo').textContent=`${session.email} · ${session.role}`;
document.getElementById('btnSignOut').onclick=()=>{localStorage.removeItem('fte-session');location.href='access.html';};

/* Month helpers (timezone-safe) */
function normalizeYM(s){
  if(!s)return s;
  const m1=/^(\d{4})-(\d{1,2})$/.exec(s); if(m1) return `${m1[1]}-${String(Number(m1[2])).padStart(2,'0')}`;
  const m2=/^(\d{4})-(\d{1,2})-(\d{1,2})$/.exec(s); if(m2) return `${m2[1]}-${String(Number(m2[2])).padStart(2,'0')}`;
  return s;
}
function ymKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function ymToDate(ym){
  const n=normalizeYM(ym); if(!n) return new Date();
  const [Y,M]=n.split('-').map(Number);
  return new Date(Y, (M||1)-1, 1);  // <- FIX: numeric ctor avoids UTC parsing & month drift
}
function dedupAndSortMonths(arr){
  const map=new Map();
  (arr||[]).forEach(m=>{
    const ym=normalizeYM(m?.ym||''); if(!ym) return;
    const d=ymToDate(ym);
    const prev=map.get(ym)||{};
    map.set(ym,{...prev,...m,ym,name:d.toLocaleString(undefined,{month:'long',year:'numeric'})});
  });
  return Array.from(map.values()).sort((a,b)=>ymToDate(a.ym)-ymToDate(b.ym));
}

/* State */
const STATE_KEY='fte-state-v2'; let state=null;
function defaultState(){
  const now=new Date();const start=new Date(now.getFullYear(),now.getMonth(),1);
  const months=buildMonths(start,12).map(m=>({ym:m.ym,name:m.name,somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false}));
  return{
    globals:{compPerHr:1.75,hoursPerDay:8,shrink:35,sl:95,defAttr:3.5,defFteAttr:3.5,ramp0:5,ramp1:50,ramp2:100},
    holiday:{},
    months,
    inbound:{ivl:30,rows:[],monthFTE:{},monthStaffed:{}}
  };
}
function repairState(raw){
  const d=defaultState();
  const g={...d.globals,...(raw?.globals||{})};
  if(g.defFteAttr==null) g.defFteAttr=g.defAttr;
  const h={};for(const k in (raw?.holiday||{})){h[normalizeYM(k)]=raw.holiday[k]||[];}
  let months=dedupAndSortMonths(raw?.months||d.months);
  months=months.map(m=>({somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false,...m,ym:normalizeYM(m.ym)}));
  if(!months.length) months=d.months;
  const inbound={...d.inbound,...(raw?.inbound||{})};
  inbound.monthFTE=inbound.monthFTE||{};
  inbound.monthStaffed=inbound.monthStaffed||{};
  return{globals:g,holiday:h,months,inbound};
}
function loadState(){try{const raw=JSON.parse(localStorage.getItem(STATE_KEY)||'null');if(!raw)return defaultState();return repairState(raw);}catch{return defaultState();}}
function saveState(){try{localStorage.setItem(STATE_KEY,JSON.stringify(state));}catch{}}

/* Calendar */
function buildMonths(startDate,count){const arr=[];for(let i=0;i<count;i++){const d=new Date(startDate.getFullYear(),startDate.getMonth()+i,1);const ym=ymKey(d);const name=d.toLocaleString(undefined,{month:'long',year:'numeric'});arr.push({ym,name});}return arr;}
function ensureMonth(ym){
  ym=normalizeYM(ym); if(!ym) return;
  const exists=state.months.find(m=>m.ym===ym);
  if(!exists){
    const d=ymToDate(ym);
    state.months.push({ym,name:d.toLocaleString(undefined,{month:'long',year:'numeric'}),somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false});
    state.months=dedupAndSortMonths(state.months);
  }
}
function getWorkdays(ym,holidaysSet){const[Y,M]=normalizeYM(ym).split('-').map(Number);if(!Y||!M)return 0;const d0=new Date(Y,M-1,1);let wd=0;for(let d=new Date(d0);d.getMonth()===M-1;d.setDate(d.getDate()+1)){const dow=d.getDay();const iso=d.toISOString().slice(0,10);if(dow>=1&&dow<=5&&!holidaysSet.has(iso))wd++;}return wd;}

/* Outbound calc */
function monthCalc(m){
  const g=state.globals,ym=normalizeYM(m.ym);
  const holidays=new Set((state.holiday[ym]||[]));
  const workdays=getWorkdays(ym,holidays);
  const hours=workdays*g.hoursPerDay;
  const aPct=(m.attritionPct==null?g.defAttr:m.attritionPct)/100;
  const attrPatients=(m.somPatients||0)*aPct;
  const netPatients=Math.max(0,(m.somPatients||0)+(m.enrollments||0)-attrPatients-(m.practiceLoss||0));
  const slPatients=Math.round(netPatients*(g.sl/100));
  const effHr=g.hoursPerDay*(1-(g.shrink/100));
  const perFTE=Math.max(0.0001,g.compPerHr*effHr);
  const denom=(workdays>0?workdays*perFTE:0);
  const fteNeed=denom>0?(slPatients/denom):0;
  const fteAttrPct=(m.fteAttritionPct==null?g.defFteAttr:m.fteAttritionPct)/100;
  const eomFTE=Math.max(0,(m.somFTE||0)-((m.somFTE||0)*fteAttrPct)+(m.newHires||0));
  return{workdays,hours,attrPatients,netPatients,slPatients,fteNeed,eomFTE};
}

/* Effective Supply (Outbound – Staff) with ramp */
function effectiveSupplyForMonth(idx){
  const g=state.globals;
  const m=state.months[idx]; if(!m) return 0;
  const som=m.somFTE||0;
  const curr=(m.newHires||0)*(g.ramp0/100);
  const p1=(state.months[idx-1]?.newHires||0);
  const p2=(state.months[idx-2]?.newHires||0);
  const r1lack = (1 - (g.ramp1/100));
  const degrade = p1*r1lack + p2*r1lack;
  const eff = Math.max(0, som - degrade + curr);
  return eff;
}

/* Erlang C (Inbound) */
function erlangC(N, a){ if(N<=0) return 1; if(a>=N) return 1; let term=1,sum=1; for(let k=1;k<N;k++){term=term*a/k;sum+=term;} const termN=term*a/N; const numer=termN*(N/(N-a)); return numer/(sum+numer); }
function serviceLevel(N,a,AHT,T){ if(N<=0) return 0; if(a===0) return 1; if(a>=N) return 0; const ec=erlangC(N,a); const sl=1-ec*Math.exp(-(N-a)*(T/AHT)); return Math.max(0,Math.min(1,sl)); }
function asa(N,a,AHT){ if(N<=a||N<=0) return Infinity; const ec=erlangC(N,a); return (ec*AHT)/(N-a); }
function findAgentsForSL(a,AHT,T,targetSL){ let N=Math.max(1,Math.ceil(a)+1); for(let i=0;i<200;i++){ if(serviceLevel(N,a,AHT,T)>=targetSL) return N; N++; } return N; }

/* Renderers */
function renderAll(){ saveState(); renderSidebar(); renderOverview(); renderExec(); renderStaffing(); renderInStaff(); renderDiag(); const hz=$('#horizon'); if(hz) $('#horizonChip').textContent=`${hz.value}-month horizon`; }
function renderSidebar(){
  const g=state.globals;
  setNum($('#g_comp'),g.compPerHr,2);setNum($('#g_hours'),g.hoursPerDay,2);setNum($('#g_shrink'),g.shrink,1);
  setNum($('#g_sl'),g.sl,0);setNum($('#g_attr'),g.defAttr,2);setNum($('#g_fteattr'),g.defFteAttr,2);
  setNum($('#r_0'),g.ramp0,1);setNum($('#r_1'),g.ramp1,1);setNum($('#r_2'),g.ramp2,0);
  $('#ioSec').style.display=(session.role==='superadmin')?'block':'none';
}

function renderOverview(){
  state.months=dedupAndSortMonths(state.months);
  const cont=$('#months'); if(!cont) return; cont.innerHTML='';
  const startSel = normalizeYM($('#startMonth')?.value)||ymKey(new Date());
  const horizon = Number($('#horizon')?.value||12);

  // Build exact view span (timezone-safe)
  const span = buildMonths(ymToDate(startSel), horizon).map(x=>x.ym);
  const map=Object.fromEntries(state.months.map(m=>[normalizeYM(m.ym),m]));
  for(const ym of span){ if(!map[ym]) ensureMonth(ym); }
  state.months=dedupAndSortMonths(state.months);

  // Auto-carry toggles (on chronological order)
  for(let i=0;i<state.months.length;i++){
    const m=state.months[i];
    if(i>0&&m.autoCarryFTE){m.somFTE=monthCalc(state.months[i-1]).eomFTE;}
    if(i>0&&m.autoSOM){m.somPatients=Math.max(0,monthCalc(state.months[i-1]).netPatients);}
  }

  // Render only the span
  span.forEach(ym=>{
    const m=state.months.find(x=>normalizeYM(x.ym)===ym);
    if(!m) return;
    const mc=monthCalc(m);
    const row=document.createElement('div');row.className='month-row'+(m.open?' open':'');
    row.innerHTML=`
      <div class="month-head">
        <div class="row"><div class="m-title">${m.name}</div><span class="muted">Workdays: ${mc.workdays} • Hours: ${mc.hours}</span></div>
        <div class="row"><button class="btn small" data-act="toggle">${m.open?'Collapse':'Expand'}</button></div>
      </div>
      <div class="kpis">
        <div class="k"><label>Start-of-Month Patients</label><input data-f="somPatients" maxlength="6" placeholder="0" value="${m.somPatients||''}"></div>
        <div class="k"><label>SL Patients (${state.globals.sl}% of Net)</label><div class="val">${mc.slPatients.toLocaleString()}</div></div>
        <div class="k"><label>FTE Need</label><div class="val">${mc.fteNeed.toFixed(1)}</div></div>
        <div class="k"><label>EOM Patients (Net)</label><div class="val">${mc.netPatients.toLocaleString()}</div></div>
        <div class="k"><label>SOM FTE</label><input data-f="somFTE" placeholder="0.0" value="${(m.somFTE||'')}"></div>
        <div class="k"><label>EOM FTE</label><div class="val">${mc.eomFTE.toFixed(1)}</div></div>
        <div class="k"><label>8h Schedules</label><div class="val">${schedBreak(mc.fteNeed,8)}</div></div>
        <div class="k"><label>10h Schedules</label><div class="val">${schedBreak(mc.fteNeed,10)}</div></div>
        <div class="k"><label>6h PT</label><div class="val">${schedBreak(mc.fteNeed,6)}</div></div>
        <div class="k"><label>4h PT</label><div class="val">${schedBreak(mc.fteNeed,4)}</div></div>
        <div class="k"><label>Auto-carry SOM FTE → next</label><select data-f="autoCarryFTE"><option value="true" ${m.autoCarryFTE?'selected':''}>On</option><option value="false" ${!m.autoCarryFTE?'selected':''}>Off</option></select></div>
        <div class="k"><label>Auto-SOM Patients (prev EOM)</label><select data-f="autoSOM"><option value="false" ${!m.autoSOM?'selected':''}>Off</option><option value="true" ${m.autoSOM?'selected':''}>On</option></select></div>
      </div>
      <div class="month-body">
        <div class="row">
          <div class="input" style="width:160px"><label>Enrollments (adds)</label><input data-f="enrollments" placeholder="0" value="${m.enrollments||''}"></div>
          <div class="input" style="width:160px"><label>Practice Loss (subs)</label><input data-f="practiceLoss" placeholder="0" value="${m.practiceLoss||''}"></div>
          <div class="input" style="width:170px"><label>Patient Attrition % (override)</label><input data-f="attritionPct" placeholder="(global)" value="${m.attritionPct==null?'':m.attritionPct}"></div>
          <div class="input" style="width:160px"><label>New Hires (FTE)</label><input data-f="newHires" placeholder="0" value="${m.newHires||''}"></div>
          <div class="input" style="width:170px"><label>FTE Attrition % (override)</label><input data-f="fteAttritionPct" placeholder="(global)" value="${m.fteAttritionPct==null?'':m.fteAttritionPct}"></div>
        </div>
        <div class="hint">Net = SOM + Enrollments − SOM×Attr% − Practice Loss. SL Patients = Net × ${state.globals.sl}%.</div>
      </div>`;
    row.querySelector('[data-act="toggle"]').onclick=()=>{m.open=!m.open;renderOverview();};
    row.querySelectorAll('input[data-f],select[data-f]').forEach(inp=>{
      inp.oninput=()=>{
        const f=inp.getAttribute('data-f');
        let v=inp.tagName==='SELECT'?inp.value:(inp.value||'').replace(/[^0-9.\-]/g,'');
        if(['somPatients','enrollments','practiceLoss','somFTE','newHires'].includes(f)){m[f]=v===''?0:parseFloat(v);}
        else if(['attritionPct','fteAttritionPct'].includes(f)){m[f]=v===''?null:parseFloat(v);}
        else if(f==='autoCarryFTE'||f==='autoSOM'){m[f]=(v==='true');}
        renderAll();
      };
    });
    cont.appendChild(row);
  });
}
function schedBreak(fte,hours){const heads=(fte*173.33)/(hours*21.666);return(!isFinite(heads)||heads<=0)?'0.0':heads.toFixed(1);}

/* Exec */
let netChart,fteChart;
function renderExec(){
  const group=document.querySelector('.execwin');
  if(group){ group.querySelectorAll('button[data-execwin]').forEach(b=>{ b.onclick=()=>{ group.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderExec(); }; }); }
  const active=group?.querySelector('button.active[data-execwin]')||group?.querySelector('button[data-execwin="1"]');
  const win=Number(active?.getAttribute('data-execwin')||1);
  const startIdx=Math.max(0,state.months.findIndex(m=>normalizeYM(m.ym)>=($('#startMonth')?.value||ymKey(new Date()))));
  const months=state.months.slice(startIdx,startIdx+win);
  if(!months.length) return;
  $('#execRange').textContent=`${months[0].name} → ${months[months.length-1].name}`;
  const cards=$('#execCards');cards.innerHTML='';
  const labels=[],nets=[],needs=[];
  months.forEach(m=>{
    const mc=monthCalc(m);labels.push(m.name);nets.push(mc.netPatients);needs.push(mc.fteNeed);
    const gap=Math.max(0,mc.fteNeed-(m.somFTE||0));
    const div=document.createElement('div');div.className='card';
    div.innerHTML=`<div class="row" style="justify-content:space-between"><strong>${m.name}</strong><span class="chip">WD ${mc.workdays}</span></div>
      <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:8px">
      <div class="chip">SOM ${Number(m.somPatients||0).toLocaleString()}</div>
      <div class="chip">Enroll ${Number(m.enrollments||0).toLocaleString()}</div>
      <div class="chip">Loss ${Number(m.practiceLoss||0).toLocaleString()}</div>
      <div class="chip">Attr ${(m.attritionPct??state.globals.defAttr).toFixed(2)}%</div></div>
      <div style="margin-top:8px">
      <div class="row"><span class="muted">EOM Patients (Net)</span><span style="margin-left:auto;font-weight:700">${mc.netPatients.toLocaleString()}</span></div>
      <div class="row"><span class="muted">SL Patients</span><span style="margin-left:auto;font-weight:700">${mc.slPatients.toLocaleString()}</span></div>
      <div class="row"><span class="muted">FTE Need</span><span style="margin-left:auto;font-weight:700">${mc.fteNeed.toFixed(1)}</span></div>
      <div class="row"><span class="muted">SOM FTE</span><span style="margin-left:auto">${(m.somFTE||0).toFixed(1)}</span></div>
      <div class="row"><span class="muted ${gap>0?'danger':'ok'}">Hiring Gap (vs SOM)</span><span style="margin-left:auto">${gap.toFixed(1)}</span></div></div>`;
    cards.appendChild(div);
  });
  const nc=document.getElementById('chartNet').getContext('2d');
  const fc=document.getElementById('chartFte').getContext('2d');
  if(netChart)netChart.destroy(); if(fteChart)fteChart.destroy();
  netChart=new Chart(nc,{type:'line',data:{labels,datasets:[{label:'EOM Patients (Net)',data:nets}]}});
  fteChart=new Chart(fc,{type:'line',data:{labels,datasets:[{label:'FTE Need',data:needs}]}});
}

/* Outbound – Staff */
function renderStaffing(){
  const tbody=$('#staffTbl tbody'); if(!tbody) return; tbody.innerHTML='';
  const mix=[readNum($('#mix8')),readNum($('#mix10')),readNum($('#mix6')),readNum($('#mix4'))];
  const sum=mix.reduce((a,b)=>a+b,0)||1;const frac=mix.map(x=>x/sum);
  let start=$('#staffStart')?.value||$('#startMonth')?.value||ymKey(new Date()); start=normalizeYM(start); ensureMonth(start);
  const idx=state.months.findIndex(m=>normalizeYM(m.ym)===start);
  const view=state.months.slice(idx,idx+12);
  view.forEach((m,i)=>{
    const mc=monthCalc(m);
    const globalIdx = idx+i;
    const effSupply = effectiveSupplyForMonth(globalIdx);
    const gapEff=Math.max(0,mc.fteNeed-effSupply);
    const r8=(gapEff*frac[0]).toFixed(1),r10=(gapEff*frac[1]).toFixed(1),r6=(gapEff*frac[2]).toFixed(1),r4=(gapEff*frac[3]).toFixed(1);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.name}</td>
      <td>${mc.fteNeed.toFixed(1)}</td>
      <td>${(m.somFTE||0).toFixed(1)}</td>
      <td>${effSupply.toFixed(1)}</td>
      <td>${gapEff.toFixed(1)}</td>
      <td>${r8}</td><td>${r10}</td><td>${r6}</td><td>${r4}</td>`;
    tbody.appendChild(tr);
  });
}

/* Inbound interval grid + CSV import/export */
function ensureInboundGrid(){
  const grid=$('#intervalGrid'); const body=$('#intervalBody');
  grid.style.display='block'; body.innerHTML='';
  const ivl = Number($('#in_ivl').value||30);
  const slots = Math.round(1440/ivl);
  const rows = [];
  for(let i=0;i<slots;i++){
    const mins=i*ivl; const hh=String(Math.floor(mins/60)).padStart(2,'0'); const mm=String(mins%60).padStart(2,'0');
    const label=`${hh}:${mm}`;
    const prev = (state.inbound.rows||[]).find(r=>r.label===label);
    rows.push({label,calls:prev?prev.calls:0, a:0, N:0, SL:0, ASA:0, Nadj:0});
  }
  state.inbound.ivl = ivl;
  state.inbound.rows = rows;
  saveState();
  rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.label}</td>
      <td><input data-in="calls" data-idx="${idx}" value="${r.calls}" style="width:100px"></td>
      <td class="muted" data-out="a" data-idx="${idx}">0.00</td>
      <td data-out="N" data-idx="${idx}">0</td>
      <td data-out="SL" data-idx="${idx}">0%</td>
      <td data-out="ASA" data-idx="${idx}">0</td>
      <td data-out="Nadj" data-idx="${idx}">0</td>`;
    body.appendChild(tr);
  });
  body.querySelectorAll('input[data-in="calls"]').forEach(inp=>{
    inp.oninput=()=>{
      const i=Number(inp.getAttribute('data-idx')); const val=parseFloat((inp.value||'').replace(/[^0-9.\-]/g,''))||0;
      state.inbound.rows[i].calls = val; saveState();
    };
  });
}
$('#btnBuildIntervals').onclick=ensureInboundGrid;

$('#btnImportInbound').onclick=()=>{
  const file = $('#in_csv').files[0];
  if(!file){ alert('Choose a CSV file first.'); return; }
  const ivl = Number($('#in_ivl').value||30);
  const slots = Math.round(1440/ivl);
  const r = new FileReader();
  r.onload=()=>{
    const text=r.result||''; const lines=text.split(/\r?\n/).filter(x=>x.trim().length);
    const hdr=lines.shift().split(',').map(x=>x.trim().toLowerCase());
    const idx=Object.fromEntries(hdr.map((h,i)=>[h,i]));
    if(idx['datetime']==null || idx['calls']==null){ alert('CSV must include datetime,calls'); return; }
    const buckets=new Array(slots).fill(0); let daysSet=new Set();
    lines.forEach(line=>{
      const c=line.split(',');
      const dt=new Date(c[idx['datetime']]); const calls=+c[idx['calls']]||0;
      if(!isFinite(dt.getTime())) return;
      const mins=dt.getHours()*60+dt.getMinutes(); const bin=Math.floor(mins/ivl);
      buckets[bin]=(buckets[bin]||0)+calls;
      daysSet.add(dt.toISOString().slice(0,10));
    });
    const days=Math.max(1,daysSet.size||1);
    ensureInboundGrid();
    for(let i=0;i<slots;i++){ state.inbound.rows[i].calls = Math.round((buckets[i]||0)/days); }
    saveState();
    $('#intervalBody').querySelectorAll('input[data-in="calls"]').forEach(inp=>{
      const i=Number(inp.getAttribute('data-idx')); inp.value=state.inbound.rows[i].calls;
    });
    alert(`Loaded ${days} day(s) into ${slots} intervals.`);
  };
  r.readAsText(file);
};

function erlangRunAndStore(){
  if(!state.inbound.rows || !state.inbound.rows.length){ ensureInboundGrid(); }
  const rows = state.inbound.rows;
  const ivl = Number($('#in_ivl').value||30);
  const AHT = readNum($('#in_aht'))||480;
  const SLtgt = (readNum($('#in_sl'))||80)/100;
  const T = readNum($('#in_t'))||30;
  const shrink = ($('#in_shrink').value.trim()? readNum($('#in_shrink')) : state.globals.shrink) / 100;
  const secs = ivl*60;

  let agentHours=0, peakAgents=0, avgAgents=0;
  rows.forEach((r)=>{
    const calls = +r.calls||0;
    const a = (calls*AHT)/secs; let N=0, sl=0, _asa=0;
    if(calls>0 && AHT>0){ N = findAgentsForSL(a, AHT, T, SLtgt); sl = serviceLevel(N,a,AHT,T); _asa = asa(N,a,AHT); }
    const Nadj = N>0 ? Math.ceil(N / Math.max(0.01,(1 - shrink))) : 0;
    r.a=a; r.N=N; r.SL=sl; r.ASA=_asa; r.Nadj=Nadj;
    agentHours += Nadj * (secs/3600);
    peakAgents = Math.max(peakAgents, Nadj);
    avgAgents += Nadj;
  });
  avgAgents = rows.length ? avgAgents/rows.length : 0;

  const ym = normalizeYM($('#in_month').value)||($('#startMonth').value)||ymKey(new Date());
  const holidays = new Set((state.holiday[ym]||[]));
  const wd = getWorkdays(ym, holidays);
  const effHoursPerFTE = state.globals.hoursPerDay * (1 - (state.globals.shrink/100));
  const dailyFTE = effHoursPerFTE>0 ? agentHours / effHoursPerFTE : 0;
  const monthlyFTE = dailyFTE * wd;

  // write table
  const body=$('#intervalBody'); if(!body){ ensureInboundGrid(); }
  body.querySelectorAll('tr').forEach((tr,i)=>{
    const r=rows[i];
    tr.querySelector('[data-out="a"]').textContent = r.a.toFixed(2);
    tr.querySelector('[data-out="N"]').textContent = r.N.toString();
    tr.querySelector('[data-out="SL"]').textContent = (r.SL*100).toFixed(0)+'%';
    tr.querySelector('[data-out="ASA"]').textContent = isFinite(r.ASA)? r.ASA.toFixed(0):'—';
    tr.querySelector('[data-out="Nadj"]').textContent = r.Nadj.toString();
  });

  // summary
  $('#intervalGrid').style.display='block';
  $('#in_summary_hdr').textContent = `${ym} · ${wd} workdays · ${ivl}-min`;
  $('#in_agent_hours').textContent = agentHours.toFixed(1);
  $('#in_avg_agents').textContent = avgAgents.toFixed(1);
  $('#in_peak_agents').textContent = peakAgents.toFixed(0);
  $('#in_daily_fte').textContent = dailyFTE.toFixed(1);
  $('#in_monthly_fte').textContent = monthlyFTE.toFixed(1);

  // store by month for Inbound – Staff tab
  if(!state.inbound.monthFTE) state.inbound.monthFTE={};
  state.inbound.monthFTE[ym] = monthlyFTE;
  saveState();
}
$('#btnInboundCalc').onclick=erlangRunAndStore;

$('#btnExportInbound').onclick=()=>{
  if(!state.inbound.rows || !state.inbound.rows.length){ alert('Nothing to export yet. Build or import intervals first.'); return; }
  const ym = normalizeYM($('#in_month').value)||($('#startMonth').value)||ymKey(new Date());
  const ivl = Number($('#in_ivl').value||30);
  const rows=state.inbound.rows;
  const hdr=['interval','calls','load_erl','agents_N','SL_pct','ASA_sec','agents_with_shrinkage'];
  const csv=[hdr.join(',')];
  rows.forEach(r=>{
    csv.push([r.label,r.calls,(r.a||0).toFixed(2),r.N||0,((r.SL||0)*100).toFixed(0),isFinite(r.ASA)?(r.ASA.toFixed(0)):'',r.Nadj||0].join(','));
  });
  const blob=new Blob([csv.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`inbound_${ym}_${ivl}min.csv`;a.click();
};

/* Inbound – Staff */
function renderInStaff(){
  const tbody=$('#inStaffTbl tbody'); if(!tbody) return; tbody.innerHTML='';
  const mix=[readNum($('#imix8')),readNum($('#imix10')),readNum($('#imix6')),readNum($('#imix4'))];
  const sum=mix.reduce((a,b)=>a+b,0)||1;const frac=mix.map(x=>x/sum);
  let start=$('#inStaffStart')?.value||$('#startMonth')?.value||ymKey(new Date()); start=normalizeYM(start); ensureMonth(start);
  const idx=state.months.findIndex(m=>normalizeYM(m.ym)===start);
  const view=state.months.slice(idx,idx+12);

  view.forEach(m=>{
    const ym=m.ym;
    const need = (state.inbound.monthFTE && state.inbound.monthFTE[ym]) ? state.inbound.monthFTE[ym] : 0;
    const staffed = (state.inbound.monthStaffed && typeof state.inbound.monthStaffed[ym]==='number') ? state.inbound.monthStaffed[ym] : 0;
    const gap = Math.max(0, need - staffed);
    const r8=(gap*frac[0]).toFixed(1),r10=(gap*frac[1]).toFixed(1),r6=(gap*frac[2]).toFixed(1),r4=(gap*frac[3]).toFixed(1);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.name}</td>
      <td>${need.toFixed(1)}</td>
      <td><input data-instaff="${ym}" value="${staffed.toFixed(1)}" style="width:90px"></td>
      <td>${gap.toFixed(1)}</td>
      <td>${r8}</td><td>${r10}</td><td>${r6}</td><td>${r4}</td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('input[data-instaff]').forEach(inp=>{
    inp.oninput=()=>{
      const ym=inp.getAttribute('data-instaff');
      const v=parseFloat((inp.value||'').replace(/[^0-9.\-]/g,''))||0;
      if(!state.inbound.monthStaffed) state.inbound.monthStaffed={};
      state.inbound.monthStaffed[ym]=v; saveState(); renderInStaff();
    };
  });
}

/* Diagnostics (+suggestions) */
function renderDiag(){
  const div=$('#diagList'); if(!div) return; div.innerHTML='';
  const g=state.globals;
  if(g.compPerHr<=0)div.append(diagItem('Comp/hr is 0 — FTE Need would be infinite.','Set Comp/hr > 0 in Global Settings.'));
  if(g.hoursPerDay<=0)div.append(diagItem('Hours/day is 0 — denominator invalid.','Set Hours/day > 0 in Global Settings.'));
  if(g.shrink>=100)div.append(diagItem('Shrinkage ≥ 100% — effective hours ≤ 0.','Use a shrinkage < 100%. Typical: 25–40%.'));
  state.months.forEach(m=>{
    if(m.somPatients<0)div.append(diagItem(`${m.name}: SOM patients < 0`,'Enter a non-negative SOM patients value.'));
    if((m.attritionPct??g.defAttr)>50)div.append(diagItem(`${m.name}: Patient attrition % unusually high`,'Verify monthly patient churn; typical 1–10%.'));
    if((m.fteAttritionPct??g.defFteAttr)>25)div.append(diagItem(`${m.name}: FTE attrition % high`,'Consider hiring buffer or retention actions.'));
  });
}
function diagItem(msg,fix){const d=document.createElement('div');d.className='diag-item';d.innerHTML=`<div><strong>${msg}</strong><div class="muted">${fix||''}</div></div>`;return d;}

/* Tabs */
document.getElementById('tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  ['overview','staff','inbound','instaff','exec','diag'].forEach(id=>$('#tab-'+id).style.display='none');
  $('#tab-'+t.getAttribute('data-tab')).style.display='block';
});

/* Global actions */
$('#btnToggleGlobal').onclick=()=>{const el=$('#globalBody');const b=$('#btnToggleGlobal');const isOpen=el.style.display!=='none';el.style.display=isOpen?'none':'block';b.textContent=isOpen?'Expand':'Collapse';};

$('#btnExportSummary').onclick=()=>{
  const mode=$('#exportMode').value;const lines=[];
  const start=$('#startMonth')?.value||ymKey(new Date());
  const idx=Math.max(0,state.months.findIndex(m=>normalizeYM(m.ym)>=start));
  const win=Number(document.querySelector('.execwin button.active[data-execwin]')?.getAttribute('data-execwin')||1);
  const view=state.months.slice(idx,idx+win);
  if(mode==='outbound'||mode==='both'){lines.push('=== Outbound Summary ===');view.forEach(m=>{const mc=monthCalc(m);lines.push(`${m.name}: SOM ${m.somPatients}, Enroll ${m.enrollments}, Loss ${m.practiceLoss}, Attr ${(m.attritionPct??state.globals.defAttr)}% → EOM ${mc.netPatients}, SL ${mc.slPatients}, FTE Need ${mc.fteNeed.toFixed(1)}, SOM FTE ${(m.somFTE||0).toFixed(1)}, EOM FTE ${mc.eomFTE.toFixed(1)}`);});lines.push('');}
  if(mode==='inbound'||mode==='both'){lines.push('=== Inbound Snapshot (monthly FTE by month) ===');view.forEach(m=>{const f=(state.inbound.monthFTE||{})[m.ym]||0;lines.push(`${m.name}: Inbound FTE ${f.toFixed(1)}`);});}
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='executive-summary.txt';a.click();
};
$('#btnCollapseAll').onclick=()=>{state.months.forEach(m=>m.open=false);renderOverview();};
$('#btnExpandAll').onclick=()=>{state.months.forEach(m=>m.open=true);renderOverview();};
$('#btnRebuild').onclick=renderAll; $('#btnStaffGo').onclick=renderStaffing; $('#btnInStaffGo').onclick=renderInStaff;

/* Global inputs -> state */
['g_comp','g_hours','g_shrink','g_sl','g_attr','g_fteattr','r_0','r_1','r_2'].forEach(id=>{
  const el=$('#'+id); if(!el) return;
  el.oninput=()=>{
    const g=state.globals;
    g.compPerHr=readNum($('#g_comp'));
    g.hoursPerDay=readNum($('#g_hours'));
    g.shrink=readNum($('#g_shrink'));
    g.sl=readNum($('#g_sl'));
    g.defAttr=readNum($('#g_attr'));
    g.defFteAttr=readNum($('#g_fteattr'));
    g.ramp0=readNum($('#r_0'));
    g.ramp1=readNum($('#r_1'));
    g.ramp2=readNum($('#r_2'));
    renderAll();
  };
});

/* Holidays UI */
$('#btnAddHoliday').onclick=()=>{const ym=normalizeYM($('#h_month').value);const dt=$('#h_date').value; if(!ym||!dt||!dt.startsWith(ym)){alert('Pick a month and a date within that month.');return} if(!state.holiday[ym])state.holiday[ym]=[]; if(!state.holiday[ym].includes(dt))state.holiday[ym].push(dt); updateHolidayList(); renderAll();};
$('#btnClearHoliday').onclick=()=>{const ym=normalizeYM($('#h_month').value); if(!ym)return; delete state.holiday[ym]; updateHolidayList(); renderAll();};
$('#h_month').oninput=updateHolidayList;
function updateHolidayList(){const ym=normalizeYM($('#h_month').value);const arr=state.holiday[ym]||[];$('#h_list').textContent=arr.length?`Holidays: ${arr.join(', ')}`:'No holidays in selected month.';}

/* Start month reactive */
$('#startMonth').addEventListener('change',()=>{
  const v=normalizeYM($('#startMonth').value);
  if($('#staffStart')) $('#staffStart').value=v;
  if($('#inStaffStart')) $('#inStaffStart').value=v;
  $('#in_month').value=v;
  renderAll();
});
$('#horizon').addEventListener('change',renderAll);

/* Outbound CSV import + JSON export */
$('#btnImportCsv').onclick=()=>{
  const f=$('#csvFile').files[0]; if(!f){alert('Choose a CSV file first.');return;}
  const r=new FileReader();
  r.onload=()=>{
    try{
      const lines=(r.result||'').split(/\r?\n/).filter(x=>x.trim());
      const headers=lines.shift().split(',').map(h=>h.trim().toLowerCase());
      const idx=Object.fromEntries(headers.map((h,i)=>[h,i]));
      const required=['month(yyyy-mm)','som_patients','enrollments','attrition_pct','practice_loss','som_fte','new_hires'];
      if(!required.every(h=>idx[h]!=null)){alert('Missing required headers. Check README.');return;}
      lines.forEach(line=>{
        const cols=line.split(',');
        const ym=(cols[idx['month(yyyy-mm)']]||'').trim();
        if(!/^\d{4}-\d{2}$/.test(ym)) return;
        ensureMonth(ym);
        const m=state.months.find(x=>x.ym===ym);
        m.somPatients=+cols[idx['som_patients']]||0;
        m.enrollments=+cols[idx['enrollments']]||0;
        m.attritionPct=(cols[idx['attrition_pct']]===''?null:(+cols[idx['attrition_pct']]||0));
        m.practiceLoss=+cols[idx['practice_loss']]||0;
        m.somFTE=+cols[idx['som_fte']]||0;
        m.newHires=+cols[idx['new_hires']]||0;
      });
      saveState(); renderAll(); alert('Outbound CSV imported.');
    }catch(e){alert('Import failed: '+e.message);}
  };
  r.readAsText(f);
};
$('#btnExportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='fte_state.json';a.click();
};

/* Init */
function init(){
  state=loadState();
  const nowYM=ymKey(new Date());
  $('#startMonth').value=normalizeYM(state.months[0]?.ym)||nowYM;
  $('#staffStart').value=$('#startMonth').value;
  $('#in_month').value=$('#startMonth').value;
  $('#inStaffStart').value=$('#startMonth').value;
  renderAll();
}
init();
</script>
</body>
</html>
