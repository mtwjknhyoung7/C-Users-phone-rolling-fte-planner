<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rolling FTE Planner</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<style>
  :root{--bg:#f5f7fb;--panel:#fff;--muted:#64748b;--text:#0f172a;--border:#e5e7eb;--brand:#18b6a0;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626;--chip:#eef2ff}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(900px 300px at -10% -10%, rgba(24,182,160,.08), transparent 60%),#f3f6fb;color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header.appbar{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 22px rgba(2,6,23,.06)}
  .brand{font-weight:800;letter-spacing:.2px}.chip{background:var(--chip);border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.muted{color:var(--muted)}.ok{color:var(--ok)}.danger{color:var(--err)}
  .wrap{display:grid;grid-template-columns:310px 1fr;gap:14px;min-height:100vh;padding:14px}
  aside.sidebar{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 22px rgba(2,6,23,.06);padding:12px;height:calc(100vh - 110px);position:sticky;top:86px;overflow:auto}
  .sec{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#fff}
  .sec h3{margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.5px;color:#334155}
  .input{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}.input label{font-size:12px;color:#64748b}
  .input input,.input select{height:38px;border:1px solid var(--border);border-radius:10px;padding:8px;width:100%}
  .hint{font-size:11px;color:#94a3b8}
  main.content{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 22px rgba(2,6,23,.06);padding:12px;min-height:calc(100vh - 110px)}
  .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#18b6a0,#12927f);border-color:#108574;color:#fff}
  .month-row{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#fff}
  .month-head{display:flex;justify-content:space-between;align-items:center;gap:10px}.m-title{font-weight:700}
  .kpis{display:grid;grid-template-columns:repeat(14,minmax(110px,1fr));gap:12px;margin-top:8px}
  .k{display:flex;flex-direction:column;gap:4px;min-width:110px}.k label{font-size:11px;color:#6b7280}
  .k input{height:38px;border:1px solid var(--border);border-radius:10px;padding:6px 8px;width:100%}
  .k input[maxlength]{font-variant-numeric:tabular-nums}
  .k .val{font-weight:700;min-height:38px;display:flex;align-items:center;padding:6px 8px;border:1px dashed #e5e7eb;border-radius:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .month-body{margin-top:10px;display:none}.month-row.open .month-body{display:block}
  .diag-item{border-left:4px solid var(--err);padding:8px;background:#fff;border:1px solid var(--border);border-left-color:var(--err);border-radius:8px;margin-bottom:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left} thead th{background:#f8fafc;font-weight:700} tbody tr:last-child td{border-bottom:none}
  .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}.seg button{border:none;background:#fff;padding:6px 10px;cursor:pointer}.seg button.active{background:linear-gradient(180deg,#18b6a0,#12927f);color:#fff}
  .card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#fff}
  .gridwrap{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .gridwrap thead th{position:sticky;top:0;z-index:1}
  @media (max-width:1180px){.wrap{grid-template-columns:1fr}aside.sidebar{position:static;height:auto}}
  /* Debug strip */
  #errbox{position:fixed;left:0;right:0;bottom:0;background:#111;color:#fff;padding:6px 10px;font:12px/1.4 monospace;z-index:99999;max-height:44vh;overflow:auto}
</style>
</head>
<body>

<!-- Auth guard (bypassed when URL has #safe) -->
<script>
(function () {
  try{
    var KEY='fte-session';
    var u=new URL(location.href);
    if(u.searchParams.get('reset')==='1'){
      try{ localStorage.removeItem('fte-state-v2'); localStorage.removeItem(KEY);}catch(e){}
    }
    var safe=(u.hash==='#safe'||u.searchParams.get('safe')==='1');
    if(safe){ try{ window.__FTE_SESSION__ = JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){} return; }
    var s=null; try{ s=JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ location.href='access.html'; return; }
    if(!s||!s.email||!s.role){ location.href='access.html'; return; }
    if(s.exp && Date.now()>=Number(s.exp)){ localStorage.removeItem(KEY); location.href='access.html'; return; }
    window.__FTE_SESSION__=s;
  }catch(e){}
})();
</script>

<header class="appbar">
  <div class="row">
    <div class="brand">Rolling FTE Planner</div>
    <span class="chip" id="horizonChip"></span>
    <span class="chip">build 2025-10-11d</span>
  </div>
  <div class="row"><span class="muted" id="userInfo"></span><button class="btn small" id="btnSignOut">Sign out</button></div>
</header>

<div class="wrap">
  <aside class="sidebar">
    <div class="sec" id="secGlobal">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Global SETTINGS</h3>
        <button id="btnToggleGlobal" class="btn small">Collapse</button>
      </div>
      <div id="globalBody">
        <div class="input"><label>Comp / hour</label><input id="g_comp" type="text" inputmode="decimal" placeholder="1.75"></div>
        <div class="row">
          <div class="input" style="flex:1"><label>Hours / day</label><input id="g_hours" type="text" inputmode="decimal" placeholder="8"></div>
          <div class="input" style="flex:1"><label>Shrinkage %</label><input id="g_shrink" type="text" inputmode="decimal" placeholder="35"></div>
        </div>
        <div class="row">
          <div class="input" style="flex:1"><label>Service Level %</label><input id="g_sl" type="text" inputmode="decimal" placeholder="95"></div>
        </div>
        <div class="row">
          <div class="input" style="flex:1"><label>FTE Attrition % (default)</label><input id="g_fteattr" type="text" inputmode="decimal" placeholder="3.5"></div>
        </div>
        <div class="hint">FTE Need = (SL×NetPatients) ÷ (Workdays×Hours/day×Comp/hr×(1−Shrinkage)).</div>
      </div>
    </div>

    <div class="sec">
      <h3>Tenure Ramp (Productivity)</h3>
      <div class="row">
        <div class="input" style="flex:1"><label>0–30 days %</label><input id="r_0" type="text" inputmode="decimal" placeholder="5"></div>
        <div class="input" style="flex:1"><label>31–60 days %</label><input id="r_1" type="text" inputmode="decimal" placeholder="50"></div>
        <div class="input" style="flex:1"><label>90+ days %</label><input id="r_2" type="text" inputmode="decimal" placeholder="100"></div>
      </div>
      <div class="hint">Ramp applies on Outbound – Staff as “Effective Supply.”</div>
    </div>

    <div class="sec">
      <h3>Holidays</h3>
      <div class="row">
        <div class="input" style="flex:1"><label>Month</label><input id="h_month" type="month"></div>
        <div class="input" style="flex:1"><label>Date</label><input id="h_date" type="date"></div>
      </div>
      <div class="row"><button class="btn small" id="btnAddHoliday">Add</button><button class="btn small" id="btnClearHoliday">Clear month</button></div>
      <div class="hint" id="h_list">No holidays in selected month.</div>
    </div>

    <div class="sec" id="ioSec">
      <h3>Data I/O (Superadmin)</h3>
      <div class="row"><input id="csvFile" type="file" accept=".csv"/><button class="btn small" id="btnImportCsv">Import Outbound CSV</button></div>
      <div class="row"><button class="btn small" id="btnExportJson">Export JSON</button></div>
      <div class="hint">CSV headers: month(YYYY-MM), som_patients, enrollments, attrition_pct, practice_loss, som_fte, new_hires</div>
    </div>
  </aside>

  <main class="content">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="overview">Outbound</button>
      <button class="tab" data-tab="staff">Outbound – Staff</button>
      <button class="tab" data-tab="inbound">Inbound</button>
      <button class="tab" data-tab="instaff">Inbound – Staff</button>
      <button class="tab" data-tab="exec">Executive Summary</button>
      <button class="tab" data-tab="diag">Diagnostics</button>
      <span class="seg" style="margin-left:auto"><button id="btnCollapseAll">Collapse all months</button><button id="btnExpandAll">Expand all</button></span>
    </div>

    <section id="tab-overview">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:200px"><label>Start month</label><input id="startMonth" type="month"></div>
        <div class="input" style="width:140px"><label>Months</label><select id="horizon"><option>6</option><option selected>12</option><option>18</option><option>24</option></select></div>
        <button class="btn small" id="btnRebuild">Apply</button>
      </div>
      <div id="months"></div>
    </section>

    <section id="tab-staff" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:220px"><label>View starting month</label><input id="staffStart" type="month"></div>
        <button class="btn small" id="btnStaffGo">Go</button>
        <div class="row" style="margin-left:auto">
          <div class="input" style="width:120px"><label>% 8h</label><input id="mix8" type="text" inputmode="decimal" placeholder="60"></div>
          <div class="input" style="width:120px"><label>% 10h</label><input id="mix10" type="text" inputmode="decimal" placeholder="20"></div>
          <div class="input" style="width:120px"><label>% 6h PT</label><input id="mix6" type="text" inputmode="decimal" placeholder="10"></div>
          <div class="input" style="width:120px"><label>% 4h PT</label><input id="mix4" type="text" inputmode="decimal" placeholder="10"></div>
        </div>
      </div>
      <table id="staffTbl">
        <thead>
          <tr>
            <th>Month</th><th>FTE Need</th>
            <th>Staffed (SOM FTE)</th><th>Effective Supply (ramp)</th>
            <th>Gap vs Effective</th><th>8h</th><th>10h</th><th>6h PT</th><th>4h PT</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">
        Effective Supply = SOM FTE − (prev1 new hires × (1−r1)) − (prev2 new hires × (1−r2)) + (this-month new hires × r0).
      </div>
    </section>

    <section id="tab-inbound" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:8px">
        <div class="row" style="gap:14px">
          <div class="input" style="width:150px"><label>Work month (holidays)</label><input id="in_month" type="month"></div>
          <div class="input" style="width:130px"><label>AHT (sec)</label><input id="in_aht" type="text" inputmode="numeric" placeholder="480" value=""></div>
          <div class="input" style="width:140px"><label>Target SL %</label><input id="in_sl" type="text" inputmode="decimal" placeholder="80" value=""></div>
          <div class="input" style="width:150px"><label>SL threshold T (sec)</label><input id="in_t" type="text" inputmode="numeric" placeholder="30" value=""></div>
          <div class="input" style="width:150px"><label>Interval (min)</label>
            <select id="in_ivl"><option>15</option><option selected>30</option><option>60</option></select>
          </div>
          <div class="input" style="width:150px"><label>Shrinkage % (override)</label><input id="in_shrink" type="text" inputmode="decimal" placeholder="(global)"></div>
        </div>

        <div class="row">
          <button class="btn small" id="btnBuildIntervals">Build empty day</button>
          <label class="btn small" style="display:inline-flex;gap:8px;align-items:center">
            <input id="in_csv" type="file" accept=".csv" style="display:none"><span>Upload CSV</span>
          </label>
          <button class="btn small" id="btnImportInbound">Import</button>
          <button class="btn small" id="btnInboundCalc">Compute staffing</button>
          <button class="btn small" id="btnExportInbound">Export</button>
        </div>
      </div>

      <div class="hint" style="margin-bottom:6px">
        CSV columns accepted: <b>datetime,calls</b> (optional <b>aht_sec,target_asa_sec</b>). We bin by interval-of-day.
        Service level: <code>SL = 1 - ErlangC × exp(-(N - a) × T / AHT)</code>, with <code>a = calls*AHT / interval_seconds</code>.
      </div>

      <div class="gridwrap" id="intervalGrid" style="display:none">
        <table>
          <thead><tr><th>Interval</th><th>Calls</th><th>Load (erl)</th><th>Agents N</th><th>SL %</th><th>ASA (s)</th><th>Agents w/ Shrink</th></tr></thead>
          <tbody id="intervalBody"></tbody>
        </table>
      </div>

      <div class="cards" style="margin-top:10px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>Daily Coverage</strong><span class="pill" id="in_summary_hdr">—</span>
          </div>
          <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:8px">
            <span class="pill">Daily agent-hours: <b id="in_agent_hours">0.0</b></span>
            <span class="pill">Avg concurrent agents: <b id="in_avg_agents">0.0</b></span>
            <span class="pill">Peak agents: <b id="in_peak_agents">0</b></span>
            <span class="pill">Daily FTE (effective): <b id="in_daily_fte">0.0</b></span>
            <span class="pill">Monthly FTE: <b id="in_monthly_fte">0.0</b></span>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-instaff" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:220px"><label>View starting month</label><input id="inStaffStart" type="month"></div>
        <button class="btn small" id="btnInStaffGo">Go</button>
        <div class="row" style="margin-left:auto">
          <div class="input" style="width:120px"><label>% 8h</label><input id="imix8" type="text" inputmode="decimal" placeholder="60"></div>
          <div class="input" style="width:120px"><label>% 10h</label><input id="imix10" type="text" inputmode="decimal" placeholder="20"></div>
          <div class="input" style="width:120px"><label>% 6h PT</label><input id="imix6" type="text" inputmode="decimal" placeholder="10"></div>
          <div class="input" style="width:120px"><label>% 4h PT</label><input id="imix4" type="text" inputmode="decimal" placeholder="10"></div>
        </div>
      </div>
      <table id="inStaffTbl">
        <thead><tr><th>Month</th><th>Inbound FTE Need</th><th>Inbound Staffed (editable)</th><th>Gap</th><th>8h</th><th>10h</th><th>6h PT</th><th>4h PT</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">Inbound need comes from the Inbound tab’s monthly computation. Enter staffed inbound FTE per month here.</div>
    </section>

    <section id="tab-exec" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row"><span class="chip" id="execRange"></span></div>
        <div class="row">
          <div class="seg execwin">
            <button class="active" data-execwin="1">Current</button>
            <button data-execwin="3">3 Mo</button>
            <button data-execwin="6">6 Mo</button>
            <button data-execwin="12">12 Mo</button>
          </div>
          <select id="exportMode" class="btn small" style="border-radius:8px">
            <option value="outbound" selected>Export: Outbound</option>
            <option value="inbound">Export: Inbound</option>
            <option value="both">Export: Both</option>
          </select>
          <button class="btn small" id="btnExportSummary">Export</button>
        </div>
      </div>
      <div class="cards" id="execCards" style="margin-top:10px"></div>
      <div class="cards" style="margin-top:10px">
        <div class="card"><canvas id="chartNet"></canvas></div>
        <div class="card"><canvas id="chartFte"></canvas></div>
      </div>
    </section>

    <section id="tab-diag" style="display:none"><div id="diagList"></div></section>
  </main>
</div>

<div id="errbox">[init] JS starting…</div>

<script>
/* ===== Debug logger ===== */
(function(){
  function log(msg){ try{
    var b=document.getElementById('errbox'); if(!b) return;
    var p=document.createElement('div'); p.textContent='['+new Date().toISOString()+'] '+msg; b.appendChild(p);
  }catch(e){} }
  window.__dbg = { log: log };
  log('JS loaded ✓');
})();

/* ===== Helpers ===== */
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
function readNum(el){ var s=((el && el.value) || '').replace(/[^0-9.\-]/g,''); var v=parseFloat(s); return isNaN(v)?0:v; }
function setNum(el,v,dec){ if(!el) return; if(dec==null) dec=0; el.value=(isFinite(v)?Number(v).toFixed(dec):''); }
function ymKey(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function normalizeYM(s){
  if(!s) return s;
  var m1 = /^(\d{4})-(\d{1,2})$/.exec(s); if(m1) return m1[1]+'-'+String(Number(m1[2])).padStart(2,'0');
  var m2 = /^(\d{4})-(\d{1,2})-(\d{1,2})$/.exec(s); if(m2) return m2[1]+'-'+String(Number(m2[2])).padStart(2,'0');
  return s;
}
function ymToDate(ym){ var n=normalizeYM(ym); if(!n) return new Date(); var parts=n.split('-'); return new Date(Number(parts[0]), Number(parts[1])-1, 1); }
function dedupAndSortMonths(arr){
  var map={}, out=[];
  (arr||[]).forEach(function(m){
    var ym = normalizeYM((m && m.ym) || ''); if(!ym) return;
    var d=ymToDate(ym);
    var prev=map[ym]||{};
    map[ym]=Object.assign({}, prev, m, {ym:ym, name:d.toLocaleString(undefined,{month:'long',year:'numeric'})});
  });
  Object.keys(map).sort(function(a,b){ return ymToDate(a)-ymToDate(b); }).forEach(function(k){ out.push(map[k]); });
  return out;
}

/* ===== State ===== */
var session = window.__FTE_SESSION__ || {email:'(safe)', role:'user'};
var STATE_KEY='fte-state-v2', state=null;
function defaultState(){
  var now=new Date(); var start=new Date(now.getFullYear(),now.getMonth(),1);
  var months=[]; for(var i=0;i<12;i++){ var d=new Date(start.getFullYear(),start.getMonth()+i,1); var ym=ymKey(d); var name=d.toLocaleString(undefined,{month:'long',year:'numeric'}); months.push({ym:ym,name:name}); }
  months=months.map(function(m){ return Object.assign({somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false}, m); });
  return {
    globals:{compPerHr:1.75,hoursPerDay:8,shrink:35,sl:95,defFteAttr:3.5,ramp0:5,ramp1:50,ramp2:100},
    holiday:{},
    months:months,
    inbound:{ivl:30,rows:[],monthFTE:{},monthStaffed:{}}
  };
}
function repairState(raw){
  var d=defaultState();
  var g=Object.assign({}, d.globals, (raw && raw.globals)||{});
  var h={}; var k;
  for(k in ((raw && raw.holiday)||{})){ h[normalizeYM(k)]=(raw.holiday[k]||[]); }
  var months=dedupAndSortMonths((raw && raw.months)||d.months).map(function(m){
    return Object.assign({somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false,ym:normalizeYM(m.ym)}, m);
  });
  if(!months.length) months=d.months;
  var inbound=Object.assign({}, d.inbound, (raw && raw.inbound)||{});
  inbound.monthFTE=inbound.monthFTE||{}; inbound.monthStaffed=inbound.monthStaffed||{};
  return {globals:g,holiday:h,months:months,inbound:inbound};
}
function loadState(){ try{ var raw=JSON.parse(localStorage.getItem(STATE_KEY)||'null'); if(!raw) return defaultState(); return repairState(raw); }catch(e){ return defaultState(); } }
function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch(e){} }

/* ===== Calculations ===== */
function getWorkdays(ym,holidaysSet){
  var parts=normalizeYM(ym).split('-'); var Y=Number(parts[0]), M=Number(parts[1]); if(!Y||!M) return 0;
  var d0=new Date(Y,M-1,1), wd=0, d=new Date(d0);
  while(d.getMonth()===M-1){ var dow=d.getDay(); var iso=d.toISOString().slice(0,10); if(dow>=1&&dow<=5 && !holidaysSet.has(iso)) wd++; d.setDate(d.getDate()+1); }
  return wd;
}
function monthCalc(m){
  var g=state.globals, ym=normalizeYM(m.ym);
  var holidays=new Set((state.holiday[ym]||[]));
  var workdays=getWorkdays(ym,holidays);
  var hours=workdays*g.hoursPerDay;
  var aPct=(m.attritionPct==null?0:m.attritionPct)/100;
  var attrPatients=(m.somPatients||0)*aPct;
  var netPatients=Math.max(0,(m.somPatients||0)+(m.enrollments||0)-attrPatients-(m.practiceLoss||0));
  var slPatients=Math.round(netPatients*(g.sl/100));
  var effHr=g.hoursPerDay*(1-(g.shrink/100));
  var perFTE=Math.max(0.0001,g.compPerHr*effHr);
  var denom=(workdays>0?workdays*perFTE:0);
  var fteNeed=denom>0?(slPatients/denom):0;
  var fteAttrPct=(m.fteAttritionPct==null?g.defFteAttr:m.fteAttritionPct)/100;
  var eomFTE=Math.max(0,(m.somFTE||0)-((m.somFTE||0)*fteAttrPct)+(m.newHires||0));
  return {workdays:workdays,hours:hours,attrPatients:attrPatients,netPatients:netPatients,slPatients:slPatients,fteNeed:fteNeed,eomFTE:eomFTE};
}
function effectiveSupplyForMonth(idx){
  var g=state.globals, m=state.months[idx]; if(!m) return 0;
  var som=m.somFTE||0;
  var curr=(m.newHires||0)*(g.ramp0/100);
  var p1=(state.months[idx-1]&&state.months[idx-1].newHires)||0;
  var p2=(state.months[idx-2]&&state.months[idx-2].newHires)||0;
  var r1lack = 1 - (g.ramp1/100);
  var r2lack = 1 - (g.ramp2/100);
  var degrade = p1*r1lack + p2*r2lack;
  return Math.max(0, som - degrade + curr);
}

/* ===== Rendering ===== */
function renderSidebar(){
  var g=state.globals;
  setNum($('#g_comp'),g.compPerHr,2); setNum($('#g_hours'),g.hoursPerDay,2); setNum($('#g_shrink'),g.shrink,1);
  setNum($('#g_sl'),g.sl,0); setNum($('#g_fteattr'),g.defFteAttr,2);
  setNum($('#r_0'),g.ramp0,1); setNum($('#r_1'),g.ramp1,1); setNum($('#r_2'),g.ramp2,0);
  var ioSec=$('#ioSec'); if(ioSec){ ioSec.style.display = (session.role==='superadmin')?'block':'none'; }
  var ui=$('#userInfo'); if(ui){ ui.textContent=(session.email||'(safe)')+' · '+(session.role||'user'); }
}
function schedBreak(fte,hours){ var heads=(fte*173.33)/(hours*21.666); return(!isFinite(heads)||heads<=0)?'0.0':heads.toFixed(1); }

function renderOverview(){
  state.months=dedupAndSortMonths(state.months);
  var cont=$('#months'); if(!cont) return; cont.innerHTML='';
  var startSel = normalizeYM(($('#startMonth')&&$('#startMonth').value) || ymKey(new Date()));
  var horizon = Number(($('#horizon')&&$('#horizon').value) || 12);

  var span=[]; for(var i=0;i<horizon;i++){ var d=new Date(ymToDate(startSel)); d.setMonth(d.getMonth()+i); span.push(ymKey(d)); }
  var map={}; state.months.forEach(function(m){ map[normalizeYM(m.ym)]=m; });
  for(var j=0;j<span.length;j++){ if(!map[span[j]]) ensureMonth(span[j]); }
  state.months=dedupAndSortMonths(state.months);

  for(var i=0;i<state.months.length;i++){
    var m=state.months[i];
    if(i>0 && m.autoCarryFTE){ m.somFTE = monthCalc(state.months[i-1]).eomFTE; }
    if(i>0 && m.autoSOM){ m.somPatients = Math.max(0, monthCalc(state.months[i-1]).netPatients); }
  }

  span.forEach(function(ym){
    var m=state.months.find(function(x){ return normalizeYM(x.ym)===ym; }); if(!m) return;
    var mc=monthCalc(m);
    var row=document.createElement('div'); row.className='month-row'+(m.open?' open':'');
    row.innerHTML =
      '<div class="month-head">'+
        '<div class="row"><div class="m-title">'+m.name+'</div><span class="muted">Workdays: '+mc.workdays+' • Hours: '+mc.hours+'</span></div>'+
        '<div class="row"><button class="btn small" data-act="toggle">'+(m.open?'Collapse':'Expand')+'</button></div>'+
      '</div>'+
      '<div class="kpis">'+
        '<div class="k"><label>Start-of-Month Patients</label><input data-f="somPatients" maxlength="6" placeholder="0" value="'+(m.somPatients||'')+'"></div>'+
        '<div class="k"><label>SL Patients ('+state.globals.sl+'% of Net)</label><div class="val">'+mc.slPatients.toLocaleString()+'</div></div>'+
        '<div class="k"><label>FTE Need</label><div class="val">'+mc.fteNeed.toFixed(1)+'</div></div>'+
        '<div class="k"><label>EOM Patients (Net)</label><div class="val">'+Math.round(mc.netPatients).toLocaleString()+'</div></div>'+
        '<div class="k"><label>SOM FTE</label><input data-f="somFTE" placeholder="0.0" value="'+(m.somFTE||'')+'"></div>'+
        '<div class="k"><label>EOM FTE</label><div class="val">'+mc.eomFTE.toFixed(1)+'</div></div>'+
        '<div class="k"><label>8h Schedules</label><div class="val">'+schedBreak(mc.fteNeed,8)+'</div></div>'+
        '<div class="k"><label>10h Schedules</label><div class="val">'+schedBreak(mc.fteNeed,10)+'</div></div>'+
        '<div class="k"><label>6h PT</label><div class="val">'+schedBreak(mc.fteNeed,6)+'</div></div>'+
        '<div class="k"><label>4h PT</label><div class="val">'+schedBreak(mc.fteNeed,4)+'</div></div>'+
        '<div class="k"><label>Auto-carry SOM FTE → next</label><select data-f="autoCarryFTE"><option value="true" '+(m.autoCarryFTE?'selected':'')+'>On</option><option value="false" '+(!m.autoCarryFTE?'selected':'')+'>Off</option></select></div>'+
        '<div class="k"><label>Auto-SOM Patients (prev EOM)</label><select data-f="autoSOM"><option value="false" '+(!m.autoSOM?'selected':'')+'>Off</option><option value="true" '+(m.autoSOM?'selected':'')+'>On</option></select></div>'+
      '</div>'+
      '<div class="month-body">'+
        '<div class="row">'+
          '<div class="input" style="width:160px"><label>Enrollments (adds)</label><input data-f="enrollments" placeholder="0" value="'+(m.enrollments||'')+'"></div>'+
          '<div class="input" style="width:160px"><label>Practice Loss (subs)</label><input data-f="practiceLoss" placeholder="0" value="'+(m.practiceLoss||'')+'"></div>'+
          '<div class="input" style="width:170px"><label>Patient Attrition %</label><input data-f="attritionPct" placeholder="(per-month)" value="'+(m.attritionPct==null?'':m.attritionPct)+'"></div>'+
          '<div class="input" style="width:160px"><label>New Hires (FTE)</label><input data-f="newHires" placeholder="0" value="'+(m.newHires||'')+'"></div>'+
          '<div class="input" style="width:170px"><label>FTE Attrition % (override)</label><input data-f="fteAttritionPct" placeholder="(global)" value="'+(m.fteAttritionPct==null?'':m.fteAttritionPct)+'"></div>'+
        '</div>'+
        '<div class="hint">Net = SOM + Enrollments − SOM×Attr% − Practice Loss. SL Patients = Net × '+state.globals.sl+'%.</div>'+
      '</div>';
    var btn=row.querySelector('[data-act="toggle"]'); if(btn){ btn.addEventListener('click', function(){ m.open=!m.open; __dbg.log('click: toggle '+m.ym); renderOverview(); }); }
    $all('input[data-f],select[data-f]', row).forEach(function(inp){
      inp.addEventListener('input', function(){
        var f=inp.getAttribute('data-f'); var v=(inp.tagName==='SELECT'? inp.value : (inp.value||'').replace(/[^0-9.\-]/g,''));
        if(f==='autoCarryFTE'||f==='autoSOM'){ m[f]=(v==='true'); }
        else if(['somPatients','enrollments','practiceLoss','somFTE','newHires'].indexOf(f)>=0){ m[f]= (v===''?0:parseFloat(v)); }
        else if(['attritionPct','fteAttritionPct'].indexOf(f)>=0){ m[f]= (v===''?null:parseFloat(v)); }
        saveState();
      });
      inp.addEventListener('blur', function(){ renderAll(); });
    });
    cont.appendChild(row);
  });
  var hz=$('#horizon'); if(hz) $('#horizonChip').textContent = hz.value+'-month horizon';
}

function ensureMonth(ym){
  ym=normalizeYM(ym); if(!ym) return;
  var exists=state.months.find(function(x){ return x.ym===ym; });
  if(!exists){
    var d=ymToDate(ym);
    state.months.push({ym:ym,name:d.toLocaleString(undefined,{month:'long',year:'numeric'}),somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false});
    state.months=dedupAndSortMonths(state.months);
  }
}

/* Exec charts (unchanged except guards) */
var netChart=null, fteChart=null;
function renderExec(){
  var group=document.querySelector('.execwin');
  if(group){
    $all('button[data-execwin]', group).forEach(function(b){
      b.addEventListener('click', function(){
        $all('button', group).forEach(function(x){ x.classList.remove('active'); });
        b.classList.add('active'); __dbg.log('click: execwin '+b.getAttribute('data-execwin')); renderExec();
      }, {once:true});
    });
  }
  var active=(group && group.querySelector('button.active[data-execwin]')) || (group && group.querySelector('button[data-execwin="1"]'));
  var win=Number(active && active.getAttribute('data-execwin') || 1);
  var startVal = ($('#startMonth') && $('#startMonth').value) || ymKey(new Date());
  var startIdx=Math.max(0, state.months.findIndex(function(m){ return normalizeYM(m.ym)>=startVal; }));
  var months=state.months.slice(startIdx, startIdx+win);
  if(!months.length) return;
  var range=$('#execRange'); if(range){ range.textContent = months[0].name+' → '+months[months.length-1].name; }
  var cards=$('#execCards'); if(cards) cards.innerHTML='';
  var labels=[], nets=[], needs=[];
  months.forEach(function(m){
    var mc=monthCalc(m); labels.push(m.name); nets.push(mc.netPatients); needs.push(mc.fteNeed);
    var gap=Math.max(0,mc.fteNeed-(m.somFTE||0));
    var div=document.createElement('div'); div.className='card';
    div.innerHTML='<div class="row" style="justify-content:space-between"><strong>'+m.name+
    '</strong><span class="chip">WD '+mc.workdays+'</span></div>'+
    '<div class="row" style="margin-top:6px;flex-wrap:wrap;gap:8px">'+
    '<div class="chip">SOM '+Number(m.somPatients||0).toLocaleString()+'</div>'+
    '<div class="chip">Enroll '+Number(m.enrollments||0).toLocaleString()+'</div>'+
    '<div class="chip">Loss '+Number(m.practiceLoss||0).toLocaleString()+'</div>'+
    '<div class="chip">Attr '+((m.attritionPct==null?0:m.attritionPct).toFixed(2))+'%</div></div>'+
    '<div style="margin-top:8px">'+
    '<div class="row"><span class="muted">EOM Patients (Net)</span><span style="margin-left:auto;font-weight:700">'+Math.round(mc.netPatients).toLocaleString()+'</span></div>'+
    '<div class="row"><span class="muted">SL Patients</span><span style="margin-left:auto;font-weight:700)">'+mc.slPatients.toLocaleString()+'</span></div>'+
    '<div class="row"><span class="muted">FTE Need</span><span style="margin-left:auto;font-weight:700)">'+mc.fteNeed.toFixed(1)+'</span></div>'+
    '<div class="row"><span class="muted">SOM FTE</span><span style="margin-left:auto)">'+(m.somFTE||0).toFixed(1)+'</span></div>'+
    '<div class="row"><span class="muted '+(gap>0?'danger':'ok')+'">Hiring Gap (vs SOM)</span><span style="margin-left:auto)">'+gap.toFixed(1)+'</span></div></div>';
    if(cards) cards.appendChild(div);
  });
  var ncEl=document.getElementById('chartNet'), fcEl=document.getElementById('chartFte');
  if(ncEl && window.Chart){
    var nc=ncEl.getContext('2d'); if(netChart) netChart.destroy();
    netChart=new Chart(nc,{type:'line',data:{labels:labels,datasets:[{label:'EOM Patients (Net)',data:nets}]}}); 
  }
  if(fcEl && window.Chart){
    var fc=fcEl.getContext('2d'); if(fteChart) fteChart.destroy();
    fteChart=new Chart(fc,{type:'line',data:{labels:labels,datasets:[{label:'FTE Need',data:needs}]}}); 
  }
}

/* Staffing + Inbound renderers (unchanged core, log clicks) */
function renderStaffing(){
  var tbody=$('#staffTbl tbody'); if(!tbody) return; tbody.innerHTML='';
  var mix=[readNum($('#mix8')),readNum($('#mix10')),readNum($('#mix6')),readNum($('#mix4'))];
  var sum=(mix[0]+mix[1]+mix[2]+mix[3])||1; var frac=mix.map(function(x){ return x/sum; });
  var start=(($('#staffStart')&&$('#staffStart').value) || ($('#startMonth')&&$('#startMonth').value) || ymKey(new Date())); start=normalizeYM(start); ensureMonth(start);
  var idx=state.months.findIndex(function(m){ return normalizeYM(m.ym)===start; });
  var view=state.months.slice(idx,idx+12);
  view.forEach(function(m,i){
    var mc=monthCalc(m), globalIdx=idx+i;
    var effSupply = effectiveSupplyForMonth(globalIdx);
    var gapEff=Math.max(0,mc.fteNeed-effSupply);
    var tr=document.createElement('tr');
    tr.innerHTML='<td>'+m.name+'</td>'+
      '<td>'+mc.fteNeed.toFixed(1)+'</td>'+
      '<td>'+((m.somFTE||0).toFixed(1))+'</td>'+
      '<td>'+effSupply.toFixed(1)+'</td>'+
      '<td>'+gapEff.toFixed(1)+'</td>'+
      '<td>'+(gapEff*frac[0]).toFixed(1)+'</td>'+
      '<td>'+(gapEff*frac[1]).toFixed(1)+'</td>'+
      '<td>'+(gapEff*frac[2]).toFixed(1)+'</td>'+
      '<td>'+(gapEff*frac[3]).toFixed(1)+'</td>';
    tbody.appendChild(tr);
  });
}

function ensureInboundGrid(){
  var grid=$('#intervalGrid'), body=$('#intervalBody'); if(!grid||!body) return;
  grid.style.display='block'; body.innerHTML='';
  var ivl=Number(($('#in_ivl')&&$('#in_ivl').value) || 30);
  var slots=Math.round(1440/ivl), rows=[];
  for(var i=0;i<slots;i++){
    var mins=i*ivl, hh=String(Math.floor(mins/60)).padStart(2,'0'), mm=String(mins%60).padStart(2,'0');
    var label=hh+':'+mm, prev=(state.inbound.rows||[]).find(function(r){ return r.label===label; });
    rows.push({label:label,calls:prev?prev.calls:0, a:0, N:0, SL:0, ASA:0, Nadj:0});
  }
  state.inbound.ivl=ivl; state.inbound.rows=rows; saveState();
  rows.forEach(function(r,idx){
    var tr=document.createElement('tr');
    tr.innerHTML='<td>'+r.label+'</td>'+
      '<td><input data-in="calls" data-idx="'+idx+'" value="'+r.calls+'" style="width:100px"></td>'+
      '<td class="muted" data-out="a" data-idx="'+idx+'">0.00</td>'+
      '<td data-out="N" data-idx="'+idx+'">0</td>'+
      '<td data-out="SL" data-idx="'+idx+'">0%</td>'+
      '<td data-out="ASA" data-idx="'+idx+'">0</td>'+
      '<td data-out="Nadj" data-idx="'+idx+'">0</td>';
    body.appendChild(tr);
  });
  $all('input[data-in="calls"]', body).forEach(function(inp){
    inp.addEventListener('input', function(){
      var i=Number(inp.getAttribute('data-idx')); var val=parseFloat((inp.value||'').replace(/[^0-9.\-]/g,''))||0;
      state.inbound.rows[i].calls=val; saveState();
    });
  });
}

function erlangC(N,a){ if(N<=0||a>=N) return 1; var term=1,sum=1; for(var k=1;k<N;k++){ term=term*a/k; sum+=term; } var termN=term*a/N; var numer=termN*(N/(N-a)); return numer/(sum+numer); }
function serviceLevel(N,a,AHT,T){ if(N<=0) return 0; if(a===0) return 1; if(a>=N) return 0; var ec=erlangC(N,a); var sl=1-ec*Math.exp(-(N-a)*(T/AHT)); return Math.max(0,Math.min(1,sl)); }
function asa(N,a,AHT){ if(N<=a||N<=0) return Infinity; var ec=erlangC(N,a); return (ec*AHT)/(N-a); }
function findAgentsForSL(a,AHT,T,targetSL){ var N=Math.max(1,Math.ceil(a)+1); for(var i=0;i<200;i++){ if(serviceLevel(N,a,AHT,T)>=targetSL) return N; N++; } return N; }

function inboundCompute(){
  var rows=state.inbound.rows; if(!rows||!rows.length) ensureInboundGrid();
  rows=state.inbound.rows;
  var ivl=Number(($('#in_ivl')&&$('#in_ivl').value)||30);
  var AHT=readNum($('#in_aht'))||480;
  var SLtgt=(readNum($('#in_sl'))||80)/100;
  var T=readNum($('#in_t'))||30;
  var shrink=(($('#in_shrink')&&$('#in_shrink').value.trim())? readNum($('#in_shrink')) : state.globals.shrink) / 100;
  var secs=ivl*60, agentHours=0, peakAgents=0, avgAgents=0;

  rows.forEach(function(r){
    var calls=+r.calls||0, a=(calls*AHT)/secs, N=0, sl=0, _asa=0;
    if(calls>0 && AHT>0){ N=findAgentsForSL(a,AHT,T,SLtgt); sl=serviceLevel(N,a,AHT,T); _asa=asa(N,a,AHT); }
    var Nadj = N>0 ? Math.ceil(N/Math.max(0.01,(1-shrink))) : 0;
    r.a=a; r.N=N; r.SL=sl; r.ASA=_asa; r.Nadj=Nadj;
    agentHours += Nadj * (secs/3600);
    peakAgents = Math.max(peakAgents, Nadj);
    avgAgents += Nadj;
  });
  avgAgents = rows.length ? avgAgents/rows.length : 0;

  var ym = normalizeYM(($('#in_month')&&$('#in_month').value) || (($('#startMonth')&&$('#startMonth').value) || ymKey(new Date())));
  var holidays=new Set((state.holiday[ym]||[])), wd=getWorkdays(ym, holidays);
  var effHoursPerFTE = state.globals.hoursPerDay * (1 - (state.globals.shrink/100));
  var dailyFTE = effHoursPerFTE>0 ? agentHours/effHoursPerFTE : 0;
  var monthlyFTE = dailyFTE * wd;

  var body=$('#intervalBody');
  if(body){ $all('tr', body).forEach(function(tr,i){
    var r=rows[i]; tr.querySelector('[data-out="a"]').textContent=r.a.toFixed(2);
    tr.querySelector('[data-out="N"]').textContent=String(r.N);
    tr.querySelector('[data-out="SL"]').textContent=(r.SL*100).toFixed(0)+'%';
    tr.querySelector('[data-out="ASA"]').textContent=isFinite(r.ASA)? r.ASA.toFixed(0):'—';
    tr.querySelector('[data-out="Nadj"]').textContent=String(r.Nadj);
  });}
  $('#intervalGrid').style.display='block';
  $('#in_summary_hdr').textContent = ym+' · '+wd+' workdays · '+ivl+'-min';
  $('#in_agent_hours').textContent = dailyFTE>0 ? (monthlyFTE/wd*effHoursPerFTE).toFixed(1) : agentHours.toFixed(1); // minor display
  $('#in_avg_agents').textContent = avgAgents.toFixed(1);
  $('#in_peak_agents').textContent = peakAgents.toFixed(0);
  $('#in_daily_fte').textContent = dailyFTE.toFixed(1);
  $('#in_monthly_fte').textContent = monthlyFTE.toFixed(1);

  state.inbound.monthFTE[ym]=monthlyFTE; saveState();
}

/* ===== Wire events (defensive) ===== */
function on(id, event, fn){
  var el = (typeof id==='string') ? document.getElementById(id) : id;
  if(el){ el.addEventListener(event, function(e){ __dbg.log('click: '+(el.id||el.getAttribute('data-tab')||el.textContent)); fn(e); }); }
}
function renderAll(){
  saveState(); renderSidebar(); renderOverview(); renderExec(); renderStaffing(); renderInStaff(); renderDiag();
  var hz=$('#horizon'); if(hz) $('#horizonChip').textContent = hz.value+'-month horizon';
}
function renderInStaff(){
  var tbody=$('#inStaffTbl tbody'); if(!tbody) return; tbody.innerHTML='';
  var mix=[readNum($('#imix8')),readNum($('#imix10')),readNum($('#imix6')),readNum($('#imix4'))];
  var sum=(mix[0]+mix[1]+mix[2]+mix[3])||1; var frac=mix.map(function(x){return x/sum;});
  var start=(($('#inStaffStart')&&$('#inStaffStart').value) || ($('#startMonth')&&$('#startMonth').value) || ymKey(new Date())); start=normalizeYM(start); ensureMonth(start);
  var idx=state.months.findIndex(function(m){ return normalizeYM(m.ym)===start; });
  var view=state.months.slice(idx,idx+12);
  view.forEach(function(m){
    var ym=m.ym, need=(state.inbound.monthFTE && state.inbound.monthFTE[ym]) ? state.inbound.monthFTE[ym] : 0;
    var staffed=(state.inbound.monthStaffed && typeof state.inbound.monthStaffed[ym]==='number') ? state.inbound.monthStaffed[ym] : 0;
    var gap=Math.max(0, need - staffed);
    var tr=document.createElement('tr');
    tr.innerHTML='<td>'+m.name+'</td><td>'+need.toFixed(1)+'</td>'+
      '<td><input data-instaff="'+ym+'" value="'+staffed.toFixed(1)+'" style="width:90px"></td>'+
      '<td>'+gap.toFixed(1)+'</td>'+
      '<td>'+(gap*frac[0]).toFixed(1)+'</td><td>'+(gap*frac[1]).toFixed(1)+'</td>'+
      '<td>'+(gap*frac[2]).toFixed(1)+'</td><td>'+(gap*frac[3]).toFixed(1)+'</td>';
    tbody.appendChild(tr);
  });
  $all('input[data-instaff]', tbody).forEach(function(inp){
    inp.addEventListener('input', function(){
      var ym=inp.getAttribute('data-instaff'); var v=parseFloat((inp.value||'').replace(/[^0-9.\-]/g,''))||0;
      state.inbound.monthStaffed[ym]=v; saveState(); renderInStaff();
    });
  });
}
function renderDiag(){
  var div=$('#diagList'); if(!div) return; div.innerHTML='';
  var g=state.globals;
  function add(msg,fix){ var d=document.createElement('div'); d.className='diag-item'; d.innerHTML='<div><strong>'+msg+'</strong><div class="muted">'+(fix||'')+'</div></div>'; div.appendChild(d); }
  if(g.compPerHr<=0)add('Comp/hr is 0 — FTE Need would be infinite.','Set Comp/hr > 0 in Global Settings.');
  if(g.hoursPerDay<=0)add('Hours/day is 0 — denominator invalid.','Set Hours/day > 0 in Global Settings.');
  if(g.shrink>=100)add('Shrinkage ≥ 100% — effective hours ≤ 0.','Use a shrinkage < 100%. Typical: 25–40%.');
  state.months.forEach(function(m){
    if(m.somPatients<0)add(m.name+': SOM patients < 0','Enter a non-negative value.');
    if((m.attritionPct==null?0:m.attritionPct)>50)add(m.name+': Patient attrition % unusually high','Verify monthly churn; typical 1–10%.');
    if((m.fteAttritionPct==null?g.defFteAttr:m.fteAttritionPct)>25)add(m.name+': FTE attrition % high','Consider buffer or retention actions.');
  });
}

/* ===== Init ===== */
function init(){
  state=loadState();
  var nowYM=ymKey(new Date());
  if($('#startMonth')) $('#startMonth').value=normalizeYM((state.months[0]&&state.months[0].ym)||nowYM);
  if($('#staffStart')) $('#staffStart').value=$('#startMonth').value;
  if($('#in_month')) $('#in_month').value=$('#startMonth').value;
  if($('#inStaffStart')) $('#inStaffStart').value=$('#startMonth').value;

  // Wire up buttons/tabs safely
  on('btnSignOut','click', function(){ localStorage.removeItem('fte-session'); location.href='access.html'; });
  on('btnToggleGlobal','click', function(){ var el=$('#globalBody'); var b=$('#btnToggleGlobal'); var open=(el && el.style.display!=='none'); if(el){ el.style.display=open?'none':'block'; } if(b){ b.textContent=open?'Expand':'Collapse'; } });
  on('btnCollapseAll','click', function(){ state.months.forEach(function(m){ m.open=false; }); renderOverview(); });
  on('btnExpandAll','click', function(){ state.months.forEach(function(m){ m.open=true; }); renderOverview(); });
  on('btnRebuild','click', function(){ renderAll(); });
  on('btnStaffGo','click', function(){ renderStaffing(); });
  on('btnInStaffGo','click', function(){ renderInStaff(); });
  on('btnBuildIntervals','click', function(){ ensureInboundGrid(); });
  on('btnImportInbound','click', function(){
    var file=($('#in_csv')&&$('#in_csv').files[0]); if(!file){ alert('Choose a CSV file first.'); return; }
    var r=new FileReader(); r.onload=function(){
      try{
        var text=r.result||''; var lines=text.split(/\r?\n/).filter(function(x){return x.trim().length;});
        var hdr=lines.shift().split(',').map(function(x){return x.trim().toLowerCase();});
        var idx={}; hdr.forEach(function(h,i){ idx[h]=i; });
        if(idx['datetime']==null || idx['calls']==null){ alert('CSV must include datetime,calls'); return; }
        var ivl=Number(($('#in_ivl')&&$('#in_ivl').value)||30), slots=Math.round(1440/ivl), buckets=new Array(slots).fill(0), daysSet={};
        lines.forEach(function(line){
          var c=line.split(','), dt=new Date(c[idx['datetime']]), calls=+c[idx['calls']]||0;
          if(!isFinite(dt.getTime())) return; var mins=dt.getHours()*60+dt.getMinutes(), bin=Math.floor(mins/ivl);
          buckets[bin]=(buckets[bin]||0)+calls; daysSet[dt.toISOString().slice(0,10)]=1;
        });
        var days=Math.max(1,Object.keys(daysSet).length||1); ensureInboundGrid();
        for(var i=0;i<slots;i++){ state.inbound.rows[i].calls = Math.round((buckets[i]||0)/days); }
        saveState(); $all('#intervalBody input[data-in="calls"]').forEach(function(inp,i){ inp.value=state.inbound.rows[i].calls; });
        alert('Loaded '+days+' day(s) into '+slots+' intervals.');
      }catch(e){ alert('Import failed: '+e.message); }
    }; r.readAsText(file);
  });
  on('btnInboundCalc','click', function(){ inboundCompute(); });
  on('btnExportInbound','click', function(){
    if(!state.inbound.rows||!state.inbound.rows.length){ alert('Nothing to export yet. Build or import intervals first.'); return; }
    var ym = normalizeYM(($('#in_month')&&$('#in_month').value) || (($('#startMonth')&&$('#startMonth').value) || ymKey(new Date())));
    var ivl = Number(($('#in_ivl')&&$('#in_ivl').value) || 30), rows=state.inbound.rows;
    var hdr=['interval','calls','load_erl','agents_N','SL_pct','ASA_sec','agents_with_shrinkage'], csv=[hdr.join(',')];
    rows.forEach(function(r){ csv.push([r.label,r.calls,(r.a||0).toFixed(2),r.N||0,((r.SL||0)*100).toFixed(0),isFinite(r.ASA)?(r.ASA.toFixed(0)):'',r.Nadj||0].join(',')); });
    var blob=new Blob([csv.join('\n')],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inbound_'+ym+'_'+ivl+'min.csv'; a.click();
  });
  on('btnExportSummary','click', function(){
    var mode=$('#exportMode').value, lines=[], start=(($('#startMonth')&&$('#startMonth').value) || ymKey(new Date()));
    var idx=Math.max(0,state.months.findIndex(function(m){ return normalizeYM(m.ym)>=start; }));
    var win=Number((document.querySelector('.execwin button.active[data-execwin]') && document.querySelector('.execwin button.active[data-execwin]').getAttribute('data-execwin')) || 1);
    var view=state.months.slice(idx,idx+win);
    if(mode==='outbound'||mode==='both'){ lines.push('=== Outbound Summary ==='); view.forEach(function(m){ var mc=monthCalc(m); lines.push(m.name+': SOM '+m.somPatients+', Enroll '+m.enrollments+', Loss '+m.practiceLoss+', Attr '+(m.attritionPct==null?0:m.attritionPct)+'% → EOM '+Math.round(mc.netPatients)+', SL '+mc.slPatients+', FTE Need '+mc.fteNeed.toFixed(1)+', SOM FTE '+(m.somFTE||0).toFixed(1)+', EOM FTE '+mc.eomFTE.toFixed(1)); }); lines.push(''); }
    if(mode==='inbound'||mode==='both'){ lines.push('=== Inbound Snapshot (monthly FTE by month) ==='); view.forEach(function(m){ var f=(state.inbound.monthFTE||{})[m.ym]||0; lines.push(m.name+': Inbound FTE '+f.toFixed(1)); }); }
    var blob=new Blob([lines.join('\n')],{type:'text/plain'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='executive-summary.txt'; a.click();
  });

  // Tabs (event delegation)
  var tabs=document.getElementById('tabs');
  if(tabs){
    tabs.addEventListener('click', function(e){
      var t=e.target && e.target.closest('.tab'); if(!t) return;
      __dbg.log('click: tab '+t.getAttribute('data-tab'));
      $all('.tab').forEach(function(x){ x.classList.remove('active'); }); t.classList.add('active');
      ['overview','staff','inbound','instaff','exec','diag'].forEach(function(id){ var el=document.getElementById('tab-'+id); if(el) el.style.display='none'; });
      var target = document.getElementById('tab-'+t.getAttribute('data-tab')); if(target) target.style.display='block';
    });
  }

  // Global inputs: save on input; render on blur
  ['g_comp','g_hours','g_shrink','g_sl','g_fteattr','r_0','r_1','r_2'].forEach(function(id){
    var el=document.getElementById(id); if(!el) return;
    var write=function(){
      var g=state.globals;
      g.compPerHr=readNum(document.getElementById('g_comp'));
      g.hoursPerDay=readNum(document.getElementById('g_hours'));
      g.shrink=readNum(document.getElementById('g_shrink'));
      g.sl=readNum(document.getElementById('g_sl'));
      g.defFteAttr=readNum(document.getElementById('g_fteattr'));
      g.ramp0=readNum(document.getElementById('r_0'));
      g.ramp1=readNum(document.getElementById('r_1'));
      g.ramp2=readNum(document.getElementById('r_2'));
    };
    el.addEventListener('input', function(){ write(); saveState(); });
    el.addEventListener('blur', function(){ write(); renderAll(); });
  });

  // Start month reactive
  var sm=document.getElementById('startMonth'); if(sm){
    sm.addEventListener('change', function(){
      var v=normalizeYM(sm.value);
      if(document.getElementById('staffStart')) document.getElementById('staffStart').value=v;
      if(document.getElementById('inStaffStart')) document.getElementById('inStaffStart').value=v;
      if(document.getElementById('in_month')) document.getElementById('in_month').value=v;
      renderAll();
    });
  }
  var hz=document.getElementById('horizon'); if(hz){ hz.addEventListener('change', renderAll); }

  __dbg.log('handlers: wired');
  renderAll();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
