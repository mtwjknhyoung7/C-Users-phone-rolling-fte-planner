<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rolling FTE Planner</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#f5f7fb;--panel:#fff;--muted:#64748b;--text:#0f172a;--border:#e5e7eb;--brand:#18b6a0;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626;--chip:#eef2ff}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(900px 300px at -10% -10%, rgba(24,182,160,.08), transparent 60%),#f3f6fb;color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header.appbar{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 22px rgba(2,6,23,.06)}
  .brand{font-weight:800;letter-spacing:.2px}.chip{background:var(--chip);border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.muted{color:var(--muted)}.ok{color:var(--ok)}.danger{color:var(--err)}
  .wrap{display:grid;grid-template-columns:310px 1fr;gap:14px;min-height:100vh;padding:14px}
  aside.sidebar{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 22px rgba(2,6,23,.06);padding:12px;height:calc(100vh - 110px);position:sticky;top:86px;overflow:auto}
  .sec{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#fff}
  .sec h3{margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.5px;color:#334155}
  .input{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}.input label{font-size:12px;color:#64748b}
  .input input,.input select{height:38px;border:1px solid var(--border);border-radius:10px;padding:8px;width:100%}
  .hint{font-size:11px;color:#94a3b8}
  main.content{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 22px rgba(2,6,23,.06);padding:12px;min-height:calc(100vh - 110px)}
  .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#18b6a0,#12927f);border-color:#108574;color:#fff}
  .month-row{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:12px;background:#fff}
  .month-head{display:flex;justify-content:space-between;align-items:center;gap:10px}.m-title{font-weight:700}
  .kpis{display:grid;grid-template-columns:repeat(14,minmax(100px,1fr));gap:12px;margin-top:8px}
  .k{display:flex;flex-direction:column;gap:4px;min-width:100px}.k label{font-size:11px;color:#6b7280}
  .k input{height:38px;border:1px solid var(--border);border-radius:10px;padding:6px 8px;width:100%}
  .k .val{font-weight:700;min-height:38px;display:flex;align-items:center;padding:6px 8px;border:1px dashed #e5e7eb;border-radius:10px}
  .month-body{margin-top:10px;display:none}.month-row.open .month-body{display:block}
  .diag-item{border-left:4px solid var(--err);padding:8px;background:#fff;border:1px solid var(--border);border-left-color:var(--err);border-radius:8px;margin-bottom:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left} thead th{background:#f8fafc;font-weight:700} tbody tr:last-child td{border-bottom:none}
  .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}.seg button{border:none;background:#fff;padding:6px 10px;cursor:pointer}.seg button.active{background:linear-gradient(180deg,#18b6a0,#12927f);color:#fff}
  .card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  @media (max-width:1180px){.wrap{grid-template-columns:1fr}aside.sidebar{position:static;height:auto}}
</style>
</head>
<body>

<!-- Auth guard (bypass with #safe or ?safe=1 for testing) -->
<script>
(function () {
  const KEY='fte-session';
  const u=new URL(location.href);
  if(u.searchParams.get('reset')==='1'){ try{localStorage.removeItem('fte-state-v2');localStorage.removeItem(KEY);}catch{} }
  const safe=(u.hash==='#safe'||u.searchParams.get('safe')==='1');
  if(safe){try{window.__FTE_SESSION__=JSON.parse(localStorage.getItem(KEY)||'null');}catch{} return;}
  let s=null;try{s=JSON.parse(localStorage.getItem(KEY)||'null');}catch{location.href='access.html';return}
  if(!s||!s.email||!s.role){location.href='access.html';return}
  if(s.exp && Date.now()>=Number(s.exp)){localStorage.removeItem(KEY);location.href='access.html';return}
  window.__FTE_SESSION__=s;
})();
</script>

<header class="appbar">
  <div class="row"><div class="brand">Rolling FTE Planner</div><span class="chip" id="horizonChip"></span></div>
  <div class="row"><span class="muted" id="userInfo"></span><button class="btn small" id="btnSignOut">Sign out</button></div>
</header>

<div class="wrap">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sec" id="secGlobal">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Global Settings</h3>
        <button id="btnToggleGlobal" class="btn small">Collapse</button>
      </div>
      <div id="globalBody">
        <div class="input"><label>Comp / hour</label><input id="g_comp" type="text" inputmode="decimal" placeholder="1.75"></div>
        <div class="row">
          <div class="input" style="flex:1"><label>Hours / day</label><input id="g_hours" type="text" inputmode="decimal" placeholder="8"></div>
          <div class="input" style="flex:1"><label>Shrinkage %</label><input id="g_shrink" type="text" inputmode="decimal" placeholder="35"></div>
        </div>
        <div class="row">
          <div class="input" style="flex:1"><label>Service Level %</label><input id="g_sl" type="text" inputmode="decimal" placeholder="95"></div>
          <div class="input" style="flex:1"><label>Patient Attrition % (default)</label><input id="g_attr" type="text" inputmode="decimal" placeholder="3.5"></div>
        </div>
        <div class="hint">FTE Need = (SL×NetPatients) ÷ (Workdays×Hours/day×Comp/hr×(1−Shrinkage)).</div>
      </div>
    </div>

    <div class="sec">
      <h3>Tenure Ramp (Productivity)</h3>
      <div class="row">
        <div class="input" style="flex:1"><label>0–30 days %</label><input id="r_0" type="text" inputmode="decimal" placeholder="5"></div>
        <div class="input" style="flex:1"><label>31–60 days %</label><input id="r_1" type="text" inputmode="decimal" placeholder="50"></div>
        <div class="input" style="flex:1"><label>90+ days %</label><input id="r_2" type="text" inputmode="decimal" placeholder="100"></div>
      </div>
      <div class="hint">Ramp affects “Effective Supply” (not Required FTE). New-hire impact shows in Staffing Breakdown.</div>
    </div>

    <div class="sec">
      <h3>Holidays</h3>
      <div class="row">
        <div class="input" style="flex:1"><label>Month</label><input id="h_month" type="month"></div>
        <div class="input" style="flex:1"><label>Date</label><input id="h_date" type="date"></div>
      </div>
      <div class="row"><button class="btn small" id="btnAddHoliday">Add</button><button class="btn small" id="btnClearHoliday">Clear month</button></div>
      <div class="hint" id="h_list">No holidays in selected month.</div>
    </div>

    <div class="sec" id="ioSec">
      <h3>Data I/O</h3>
      <div class="row"><input id="csvFile" type="file" accept=".csv"/><button class="btn small" id="btnImportCsv">Import CSV</button></div>
      <div class="row"><button class="btn small" id="btnExportJson">Export JSON</button></div>
      <div class="hint">CSV headers: month(YYYY-MM), som_patients, enrollments, attrition_pct, practice_loss, som_fte, new_hires</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="content">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="exec">Executive Summary</button>
      <button class="tab" data-tab="overview">Overview</button>
      <button class="tab" data-tab="staff">Staffing Breakdown</button>
      <button class="tab" data-tab="inbound">Inbound</button>
      <button class="tab" data-tab="diag">Diagnostics</button>
      <span class="seg" style="margin-left:auto"><button id="btnCollapseAll">Collapse all months</button><button id="btnExpandAll">Expand all</button></span>
    </div>

    <!-- Exec Summary -->
    <section id="tab-exec">
      <div class="row" style="justify-content:space-between">
        <div class="row"><span class="chip" id="execRange"></span></div>
        <div class="row">
          <div class="seg execwin">
            <button class="active" data-execwin="1">Current</button>
            <button data-execwin="3">3 Mo</button>
            <button data-execwin="6">6 Mo</button>
            <button data-execwin="12">12 Mo</button>
          </div>
          <select id="exportMode" class="btn small" style="border-radius:8px">
            <option value="outbound" selected>Export: Outbound</option>
            <option value="inbound">Export: Inbound</option>
            <option value="both">Export: Both</option>
          </select>
          <button class="btn small" id="btnExportSummary">Export</button>
        </div>
      </div>
      <div class="cards" id="execCards" style="margin-top:10px"></div>
      <div class="cards" style="margin-top:10px">
        <div class="card"><canvas id="chartNet"></canvas></div>
        <div class="card"><canvas id="chartFte"></canvas></div>
      </div>
    </section>

    <!-- Overview -->
    <section id="tab-overview" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:200px"><label>Start month</label><input id="startMonth" type="month"></div>
        <div class="input" style="width:140px"><label>Months</label><select id="horizon"><option>6</option><option selected>12</option><option>18</option><option>24</option></select></div>
        <button class="btn small" id="btnRebuild">Apply</button>
      </div>
      <div id="months"></div>
    </section>

    <!-- Staffing Breakdown -->
    <section id="tab-staff" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:220px"><label>View starting month</label><input id="staffStart" type="month"></div>
        <button class="btn small" id="btnStaffGo">Go</button>
        <div class="row" style="margin-left:auto">
          <div class="input" style="width:120px"><label>% 8h</label><input id="mix8" type="text" inputmode="decimal" placeholder="60"></div>
          <div class="input" style="width:120px"><label>% 10h</label><input id="mix10" type="text" inputmode="decimal" placeholder="20"></div>
          <div class="input" style="width:120px"><label>% 6h PT</label><input id="mix6" type="text" inputmode="decimal" placeholder="10"></div>
          <div class="input" style="width:120px"><label>% 4h PT</label><input id="mix4" type="text" inputmode="decimal" placeholder="10"></div>
        </div>
      </div>
      <table id="staffTbl">
        <thead><tr><th>Month</th><th>FTE Need</th><th>Staffed (SOM FTE)</th><th>Gap</th><th>8h</th><th>10h</th><th>6h PT</th><th>4h PT</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">Mix applies to FTE gap. New hires ramp by Tenure settings; effective supply adjusts next months.</div>
    </section>

    <!-- Inbound -->
    <section id="tab-inbound" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="input" style="width:150px"><label>AHT (sec)</label><input id="in_aht" type="text" inputmode="numeric" placeholder="480"></div>
        <div class="input" style="width:150px"><label>Target ASA (sec)</label><input id="in_asa" type="text" inputmode="numeric" placeholder="30"></div>
        <div class="input" style="width:150px"><label>Calls / month</label><input id="in_calls" type="text" inputmode="numeric" placeholder="0"></div>
        <button class="btn small" id="btnInboundCalc">Quick Calc</button>
      </div>
      <div id="inboundResult" class="ok"></div>
      <div class="hint" style="margin-top:8px">Upload 30-min interval history later to extend to Erlang interval staffing.</div>
    </section>

    <!-- Diagnostics -->
    <section id="tab-diag" style="display:none"><div id="diagList"></div></section>
  </main>
</div>

<script>
/* ===== Utilities ===== */
const session=window.__FTE_SESSION__||{email:'(safe)',role:'user'};
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const readNum=el=>{const s=(el?.value||'').replace(/[^0-9.\-]/g,'');const v=parseFloat(s);return isNaN(v)?0:v;}
const setNum=(el,v,dec=0)=>{el.value=(isFinite(v)?Number(v).toFixed(dec):'');}
const safe = f => { try{ return f(); } catch(_){ return undefined; } };

document.getElementById('userInfo').textContent=`${session.email} · ${session.role}`;
document.getElementById('btnSignOut').onclick=()=>{localStorage.removeItem('fte-session');location.href='access.html';};

/* Month helpers */
function normalizeYM(s){if(!s)return s;const m1=/^(\d{4})-(\d{1,2})$/.exec(s);if(m1)return`${m1[1]}-${String(Number(m1[2])).padStart(2,'0')}`;const m2=/^(\d{4})-(\d{1,2})-(\d{1,2})$/.exec(s);if(m2)return`${m2[1]}-${String(Number(m2[2])).padStart(2,'0')}`;return s;}
function ymKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function ymToDate(ym){return new Date((normalizeYM(ym)||'1970-01')+'-01');}
function dedupAndSortMonths(arr){const map=new Map();(arr||[]).forEach(m=>{const ym=normalizeYM(m?.ym||'');if(!ym)return;const prev=map.get(ym)||{};map.set(ym,{...prev,...m,ym,name:ymToDate(ym).toLocaleString(undefined,{month:'long',year:'numeric'})});});return Array.from(map.values()).sort((a,b)=>ymToDate(a.ym)-ymToDate(b.ym));}

/* State */
const STATE_KEY='fte-state-v2'; let state=null;

function defaultState(){
  const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),1);
  const months=buildMonths(start,12).map(m=>({
    ym:m.ym,name:m.name,somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,
    somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false
  }));
  return {globals:{compPerHr:1.75,hoursPerDay:8,shrink:35,sl:95,defAttr:3.5,ramp0:5,ramp1:50,ramp2:100},holiday:{},months};
}
function repairState(raw){
  const d=defaultState();
  const g={...d.globals,...(raw?.globals||{})};
  const h={}; for(const k in (raw?.holiday||{})){h[normalizeYM(k)]=raw.holiday[k]||[];}
  let months=dedupAndSortMonths(raw?.months||d.months);
  months=months.map(m=>({somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false,...m,ym:normalizeYM(m.ym)}));
  if(!months.length) months=d.months;
  return {globals:g,holiday:h,months};
}
function loadState(){
  try{
    const raw=JSON.parse(localStorage.getItem(STATE_KEY)||'null');
    if(!raw) return defaultState();
    return repairState(raw);
  }catch{ return defaultState(); }
}
function saveState(){ try{ localStorage.setItem(STATE_KEY,JSON.stringify(state)); }catch{} }

/* Calendar */
function buildMonths(startDate,count){const arr=[];for(let i=0;i<count;i++){const d=new Date(startDate.getFullYear(),startDate.getMonth()+i,1);const ym=ymKey(d);const name=d.toLocaleString(undefined,{month:'long',year:'numeric'});arr.push({ym,name});}return arr;}
function getWorkdays(ym,holidaysSet){const[Y,M]=normalizeYM(ym).split('-').map(Number);if(!Y||!M)return 0;const d0=new Date(Y,M-1,1);let wd=0;for(let d=new Date(d0);d.getMonth()===M-1;d.setDate(d.getDate()+1)){const dow=d.getDay();const iso=d.toISOString().slice(0,10);if(dow>=1&&dow<=5&&!holidaysSet.has(iso))wd++;}return wd;}

/* Core calc */
function monthCalc(m){const g=state.globals,ym=normalizeYM(m.ym);const holidays=new Set((state.holiday[ym]||[]));const workdays=getWorkdays(ym,holidays);const hours=workdays*g.hoursPerDay;const aPct=(m.attritionPct==null?g.defAttr:m.attritionPct)/100;const attrPatients=(m.somPatients||0)*aPct;const netPatients=Math.max(0,(m.somPatients||0)+(m.enrollments||0)-attrPatients-(m.practiceLoss||0));const slPatients=Math.round(netPatients*(g.sl/100));const effHr=g.hoursPerDay*(1-(g.shrink/100));const perFTE=g.compPerHr*effHr;const denom=workdays>0?(workdays*perFTE):0;const fteNeed=denom>0?(slPatients/denom):0;const fteAttrPct=(m.fteAttritionPct==null?g.defAttr:m.fteAttritionPct)/100;const eomFTE=Math.max(0,(m.somFTE||0)-((m.somFTE||0)*fteAttrPct)+(m.newHires||0));return{workdays,hours,attrPatients,netPatients,slPatients,fteNeed,eomFTE};}

/* Renderers */
function renderAll(){
  saveState();
  renderSidebar();
  renderOverview();
  renderExec();
  renderStaffing();
  renderDiag();
  const hz = document.getElementById('horizon'); if(hz) document.getElementById('horizonChip').textContent = `${hz.value}-month horizon`;
}

function renderSidebar(){
  const g=state.globals;
  setNum($('#g_comp'),g.compPerHr,2);setNum($('#g_hours'),g.hoursPerDay,2);setNum($('#g_shrink'),g.shrink,1);setNum($('#g_sl'),g.sl,0);setNum($('#g_attr'),g.defAttr,2);
  setNum($('#r_0'),g.ramp0,1);setNum($('#r_1'),g.ramp1,1);setNum($('#r_2'),g.ramp2,0);
  $('#ioSec').style.display=(session.role==='superadmin')?'block':'none';
}

function renderOverview(){
  state.months=dedupAndSortMonths(state.months);
  const cont=$('#months'); if(!cont) return; cont.innerHTML='';
  const startMonth=$('#startMonth')?.value||ymKey(new Date());
  const horizon=Number($('#horizon')?.value||12);
  const span=buildMonths(new Date(startMonth+'-01'),horizon).map(x=>x.ym);

  const map=Object.fromEntries(state.months.map(m=>[normalizeYM(m.ym),m]));
  for(const ym of span){
    if(!map[ym]){
      const d=ymToDate(ym);
      state.months.push({ym,name:d.toLocaleString(undefined,{month:'long',year:'numeric'}),somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false});
    }
  }
  state.months=dedupAndSortMonths(state.months);

  for(let i=0;i<state.months.length;i++){
    const m=state.months[i];
    if(i>0&&m.autoCarryFTE){m.somFTE=monthCalc(state.months[i-1]).eomFTE;}
    if(i>0&&m.autoSOM){m.somPatients=Math.max(0,monthCalc(state.months[i-1]).netPatients);}
  }

  state.months.filter(m=>span.includes(normalizeYM(m.ym))).sort((a,b)=>ymToDate(a.ym)-ymToDate(b.ym)).forEach(m=>{
    const mc=monthCalc(m);
    const row=document.createElement('div');row.className='month-row'+(m.open?' open':'');
    row.innerHTML=`
      <div class="month-head">
        <div class="row"><div class="m-title">${m.name}</div><span class="muted">Workdays: ${mc.workdays} • Hours: ${mc.hours}</span></div>
        <div class="row"><button class="btn small" data-act="toggle">${m.open?'Collapse':'Expand'}</button></div>
      </div>
      <div class="kpis">
        <div class="k"><label>Start-of-Month Patients</label><input data-f="somPatients" maxlength="6" placeholder="0" value="${m.somPatients||''}"></div>
        <div class="k"><label>SL Patients (${state.globals.sl}% of Net)</label><div class="val">${mc.slPatients.toLocaleString()}</div></div>
        <div class="k"><label>FTE Need</label><div class="val">${mc.fteNeed.toFixed(1)}</div></div>
        <div class="k"><label>EOM Patients (Net)</label><div class="val">${mc.netPatients.toLocaleString()}</div></div>
        <div class="k"><label>SOM FTE</label><input data-f="somFTE" placeholder="0.0" value="${(m.somFTE||0)}"></div>
        <div class="k"><label>EOM FTE</label><div class="val">${mc.eomFTE.toFixed(1)}</div></div>
        <div class="k"><label>8h Schedules</label><div class="val">${schedBreak(mc.fteNeed,8)}</div></div>
        <div class="k"><label>10h Schedules</label><div class="val">${schedBreak(mc.fteNeed,10)}</div></div>
        <div class="k"><label>6h PT</label><div class="val">${schedBreak(mc.fteNeed,6)}</div></div>
        <div class="k"><label>4h PT</label><div class="val">${schedBreak(mc.fteNeed,4)}</div></div>
        <div class="k"><label>Auto-carry SOM FTE → next</label><select data-f="autoCarryFTE"><option value="true" ${m.autoCarryFTE?'selected':''}>On</option><option value="false" ${!m.autoCarryFTE?'selected':''}>Off</option></select></div>
        <div class="k"><label>Auto-SOM Patients (prev EOM)</label><select data-f="autoSOM"><option value="false" ${!m.autoSOM?'selected':''}>Off</option><option value="true" ${m.autoSOM?'selected':''}>On</option></select></div>
      </div>
      <div class="month-body">
        <div class="row">
          <div class="input" style="width:160px"><label>Enrollments (adds)</label><input data-f="enrollments" placeholder="0" value="${m.enrollments||''}"></div>
          <div class="input" style="width:160px"><label>Practice Loss (subs)</label><input data-f="practiceLoss" placeholder="0" value="${m.practiceLoss||''}"></div>
          <div class="input" style="width:170px"><label>Patient Attrition % (override)</label><input data-f="attritionPct" placeholder="(global)" value="${m.attritionPct==null?'':m.attritionPct}"></div>
          <div class="input" style="width:160px"><label>New Hires (FTE)</label><input data-f="newHires" placeholder="0" value="${m.newHires||''}"></div>
          <div class="input" style="width:170px"><label>FTE Attrition % (override)</label><input data-f="fteAttritionPct" placeholder="(global)" value="${m.fteAttritionPct==null?'':m.fteAttritionPct}"></div>
        </div>
        <div class="hint">Net = SOM + Enrollments − SOM×Attr% − Practice Loss. SL Patients = Net × ${state.globals.sl}%.</div>
      </div>`;
    row.querySelector('[data-act="toggle"]').onclick=()=>{ m.open=!m.open; renderOverview(); };
    row.querySelectorAll('input[data-f],select[data-f]').forEach(inp=>{
      inp.oninput=()=>{
        const f=inp.getAttribute('data-f');
        let v=inp.tagName==='SELECT'?inp.value:(inp.value||'').replace(/[^0-9.\-]/g,'');
        if(['somPatients','enrollments','practiceLoss','somFTE','newHires'].includes(f)){ m[f]=v===''?0:parseFloat(v); }
        else if(['attritionPct','fteAttritionPct'].includes(f)){ m[f]=v===''?null:parseFloat(v); }
        else if(f==='autoCarryFTE'||f==='autoSOM'){ m[f]=(v==='true'); }
        renderAll();
      };
    });
    cont.appendChild(row);
  });
}

function schedBreak(fte,hours){const heads=(fte*173.33)/(hours*21.666);return(!isFinite(heads)||heads<=0)?'0.0':heads.toFixed(1);}

let netChart,fteChart;
function renderExec(){
  const group=document.querySelector('.execwin');
  const active=group?.querySelector('button.active[data-execwin]')||group?.querySelector('button[data-execwin="1"]');
  const win=Number(active?.getAttribute('data-execwin')||1);
  const startIdx=Math.max(0,state.months.findIndex(m=>normalizeYM(m.ym)>=($('#startMonth')?.value||ymKey(new Date()))));
  const months=state.months.slice(startIdx,startIdx+win);
  if(!months.length) return;
  $('#execRange').textContent=`${months[0].name} → ${months[months.length-1].name}`;
  const cards=$('#execCards');cards.innerHTML='';
  const labels=[],nets=[],needs=[];
  months.forEach(m=>{
    const mc=monthCalc(m);labels.push(m.name);nets.push(mc.netPatients);needs.push(mc.fteNeed);
    const gap=Math.max(0,mc.fteNeed-(m.somFTE||0));
    const div=document.createElement('div');div.className='card';
    div.innerHTML=`<div class="row" style="justify-content:space-between"><strong>${m.name}</strong><span class="chip">WD ${mc.workdays}</span></div>
      <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:8px">
      <div class="chip">SOM ${Number(m.somPatients||0).toLocaleString()}</div>
      <div class="chip">Enroll ${Number(m.enrollments||0).toLocaleString()}</div>
      <div class="chip">Loss ${Number(m.practiceLoss||0).toLocaleString()}</div>
      <div class="chip">Attr ${(m.attritionPct??state.globals.defAttr).toFixed(2)}%</div></div>
      <div style="margin-top:8px">
      <div class="row"><span class="muted">EOM Patients (Net)</span><span style="margin-left:auto;font-weight:700">${mc.netPatients.toLocaleString()}</span></div>
      <div class="row"><span class="muted">SL Patients</span><span style="margin-left:auto;font-weight:700">${mc.slPatients.toLocaleString()}</span></div>
      <div class="row"><span class="muted">FTE Need</span><span style="margin-left:auto;font-weight:700">${mc.fteNeed.toFixed(1)}</span></div>
      <div class="row"><span class="muted">SOM FTE</span><span style="margin-left:auto">${(m.somFTE||0).toFixed(1)}</span></div>
      <div class="row"><span class="muted ${gap>0?'danger':'ok'}">Hiring Gap</span><span style="margin-left:auto">${gap.toFixed(1)}</span></div></div>`;
    cards.appendChild(div);
  });
  const nc=document.getElementById('chartNet').getContext('2d');
  const fc=document.getElementById('chartFte').getContext('2d');
  if(netChart)netChart.destroy(); if(fteChart)fteChart.destroy();
  netChart=new Chart(nc,{type:'line',data:{labels,datasets:[{label:'EOM Patients (Net)',data:nets}]}});
  fteChart=new Chart(fc,{type:'line',data:{labels,datasets:[{label:'FTE Need',data:needs}]}});
}

function renderStaffing(){
  const tbody=$('#staffTbl tbody'); if(!tbody) return; tbody.innerHTML='';
  const mix=[readNum($('#mix8')),readNum($('#mix10')),readNum($('#mix6')),readNum($('#mix4'))];
  const sum=mix.reduce((a,b)=>a+b,0)||1;const frac=mix.map(x=>x/sum);
  const start=$('#staffStart')?.value||$('#startMonth')?.value||ymKey(new Date());
  const startIdx=Math.max(0,state.months.findIndex(m=>normalizeYM(m.ym)>=start));
  const view=state.months.slice(startIdx,startIdx+12);
  view.forEach(m=>{
    const mc=monthCalc(m);const gap=Math.max(0,mc.fteNeed-(m.somFTE||0));
    const r8=(gap*frac[0]).toFixed(1),r10=(gap*frac[1]).toFixed(1),r6=(gap*frac[2]).toFixed(1),r4=(gap*frac[3]).toFixed(1);
    const tr=document.createElement('tr');tr.innerHTML=`<td>${m.name}</td><td>${mc.fteNeed.toFixed(1)}</td><td>${(m.somFTE||0).toFixed(1)}</td><td>${gap.toFixed(1)}</td><td>${r8}</td><td>${r10}</td><td>${r6}</td><td>${r4}</td>`;tbody.appendChild(tr);
  });
}

function renderDiag(){const div=$('#diagList'); if(!div) return; div.innerHTML='';const g=state.globals;if(g.compPerHr<=0)div.append(diagItem('Comp/hr is 0 — FTE Need would be infinite. Set a positive Comp/hr.'));state.months.forEach(m=>{if(m.somPatients<0)div.append(diagItem(`${m.name}: SOM patients < 0`));if((m.attritionPct??g.defAttr)>50)div.append(diagItem(`${m.name}: Patient attrition % unusually high`));});}
function diagItem(msg){const d=document.createElement('div');d.className='diag-item';d.textContent=msg;return d;}

/* Delegated events (so tabs never break) */
document.getElementById('tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  ['exec','overview','staff','inbound','diag'].forEach(id=>$('#tab-'+id).style.display='none');
  $('#tab-'+t.getAttribute('data-tab')).style.display='block';
});
document.body.addEventListener('click',e=>{
  const b=e.target.closest('.execwin button[data-execwin]'); if(!b) return;
  document.querySelectorAll('.execwin button[data-execwin]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); renderExec();
});

/* Other events */
$('#btnToggleGlobal').onclick=()=>{const el=$('#globalBody');const b=$('#btnToggleGlobal');const isOpen=el.style.display!=='none';el.style.display=isOpen?'none':'block';b.textContent=isOpen?'Expand':'Collapse';};
$('#btnExportSummary').onclick=()=>{
  const mode=$('#exportMode').value;const lines=[];
  const start=$('#startMonth')?.value||ymKey(new Date());
  const idx=Math.max(0,state.months.findIndex(m=>normalizeYM(m.ym)>=start));
  const win=Number(document.querySelector('.execwin button.active[data-execwin]')?.getAttribute('data-execwin')||1);
  const view=state.months.slice(idx,idx+win);
  if(mode==='outbound'||mode==='both'){lines.push('=== Outbound Summary ===');view.forEach(m=>{const mc=monthCalc(m);lines.push(`${m.name}: SOM ${m.somPatients}, Enroll ${m.enrollments}, Loss ${m.practiceLoss}, Attr ${(m.attritionPct??state.globals.defAttr)}% → EOM ${mc.netPatients}, SL ${mc.slPatients}, FTE Need ${mc.fteNeed.toFixed(1)}, SOM FTE ${(m.somFTE||0).toFixed(1)}, EOM FTE ${mc.eomFTE.toFixed(1)}`);});lines.push('');}
  if(mode==='inbound'||mode==='both'){lines.push('=== Inbound Snapshot ===');const aht=readNum($('#in_aht')),asa=readNum($('#in_asa')),calls=readNum($('#in_calls'));lines.push(`AHT ${aht}s, ASA ${asa}s, Calls/mo ${calls}`);}
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='executive-summary.txt';a.click();
};
$('#btnCollapseAll').onclick=()=>{state.months.forEach(m=>m.open=false);renderOverview();};
$('#btnExpandAll').onclick=()=>{state.months.forEach(m=>m.open=true);renderOverview();};
$('#btnRebuild').onclick=renderAll; $('#btnStaffGo').onclick=renderStaffing;

['g_comp','g_hours','g_shrink','g_sl','g_attr','r_0','r_1','r_2'].forEach(id=>{
  const el=$('#'+id); if(!el) return;
  el.oninput=()=>{const g=state.globals;g.compPerHr=readNum($('#g_comp'));g.hoursPerDay=readNum($('#g_hours'));g.shrink=readNum($('#g_shrink'));g.sl=readNum($('#g_sl'));g.defAttr=readNum($('#g_attr'));g.ramp0=readNum($('#r_0'));g.ramp1=readNum($('#r_1'));g.ramp2=readNum($('#r_2'));renderAll();};
});

$('#btnAddHoliday').onclick=()=>{const ym=normalizeYM($('#h_month').value);const dt=$('#h_date').value; if(!ym||!dt||!dt.startsWith(ym)){alert('Pick a month and a date within that month.');return} if(!state.holiday[ym])state.holiday[ym]=[]; if(!state.holiday[ym].includes(dt))state.holiday[ym].push(dt); updateHolidayList(); renderAll();};
$('#btnClearHoliday').onclick=()=>{const ym=normalizeYM($('#h_month').value); if(!ym)return; delete state.holiday[ym]; updateHolidayList(); renderAll();};
$('#h_month').oninput=updateHolidayList;
function updateHolidayList(){const ym=normalizeYM($('#h_month').value);const arr=state.holiday[ym]||[];$('#h_list').textContent=arr.length?`Holidays: ${arr.join(', ')}`:'No holidays in selected month.';}

$('#btnInboundCalc').onclick=()=>{const aht=readNum($('#in_aht')),asa=readNum($('#in_asa')),calls=readNum($('#in_calls'));const secsPerMonth=aht*calls;const hrsPerFTE=state.globals.hoursPerDay*21.666*(1-state.globals.shrink/100);const fte=secsPerMonth/3600/(state.globals.compPerHr*hrsPerFTE||1);$('#inboundResult').textContent=`Rough inbound FTE (no Erlang): ${Math.max(0,fte).toFixed(1)} (AHT ${aht}s, ASA ${asa}s, Calls ${calls})`;};

$('#btnImportCsv').onclick=()=>{
  const file=$('#csvFile').files[0]; if(!file){alert('Pick a CSV file.');return}
  const r=new FileReader();
  r.onload=()=>{
    const text=r.result; const rows=text.split(/\r?\n/).filter(x=>x.trim().length);
    const hdr=rows.shift().split(',').map(x=>x.trim().toLowerCase()); const idx=Object.fromEntries(hdr.map((h,i)=>[h,i]));
    let count=0;
    rows.forEach(line=>{
      const c=line.split(','); if(c.length<2) return;
      const ym=normalizeYM((c[idx['month']]||'').trim()); if(!ym) return;
      let m=state.months.find(x=>normalizeYM(x.ym)===ym);
      if(!m){const d=ymToDate(ym);state.months.push({ym,name:d.toLocaleString(undefined,{month:'long',year:'numeric'}),somPatients:0,enrollments:0,practiceLoss:0,attritionPct:null,somFTE:0,newHires:0,fteAttritionPct:null,autoCarryFTE:true,autoSOM:false,open:false});m=state.months.find(x=>normalizeYM(x.ym)===ym);}
      m.somPatients=+c[idx['som_patients']]||0; m.enrollments=+c[idx['enrollments']]||0;
      m.attritionPct=c[idx['attrition_pct']]? (+c[idx['attrition_pct']]) : null;
      m.practiceLoss=+c[idx['practice_loss']]||0; m.somFTE=+c[idx['som_fte']]||0; m.newHires=+c[idx['new_hires']]||0;
      count++;
    });
    state.months=dedupAndSortMonths(state.months); saveState(); renderAll(); alert(`Imported ${count} row(s).`);
  };
  r.readAsText(file);
};

$('#btnExportJson').onclick=()=>{
  if(session.role!=='superadmin'){alert('Only superadmin can export JSON.');return}
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='fte-state.json';a.click();
};

/* Init */
function init(){
  try{
    state=loadState();
    const nowYM=ymKey(new Date());
    if($('#startMonth')) $('#startMonth').value=normalizeYM(state.months[0]?.ym)||nowYM;
    if($('#staffStart')) $('#staffStart').value=$('#startMonth').value;
    renderAll();
  }catch(e){
    console.error('Init failed; resetting state',e);
    localStorage.removeItem(STATE_KEY);
    state=defaultState(); renderAll();
  }
}
init();
</script>
</body>
</html>
